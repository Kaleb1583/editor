<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monaco HTML Editor (gh)</title>

    <!-- css stylesheets -->
    <link rel="stylesheet" href="./assets/css/styles.css"> <!-- main css for editor -->
    <link rel="stylesheet" href="./assets/css/so.css"> <!-- christmas snow overlay -->
    <!-- end of css -->

    <noscript>
        <style>
            .editor-container {
                display: none;
            }
        </style>
        <p>get a browser with javascript or re-enable js to use the editor.</p>
    </noscript>

    <script> // before loading / importing
        var scriptsLoaded = []; // scripts below use this variable so its needs to be defined before the scripts run.
        
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>

    <!-- scripts -->
        <script id="ScriptElement" src="./assets/monaco-editor/0.52.2/min/vs/loader.js"></script>
    <!-- end of scripts -->

</head>

<body class="body">

    <div id="alert-container"></div>

    <div id="editor-container" class="editor-container">

        <header id="header" class="top-bar">
            <div id="buttons">
                <button style="color: white" id="shareBtn" onclick="openShareMenu()">Share</button>
                <button style="color: white" id="snippetsBtn" onclick="openSnippets()">Snippets</button>
                <button style="color: white" id="fullscreenBtn">Full Screen</button>
                <button style="color: white" id="exportBtn" onclick="mkExport()">Export</button>
                <button style="color: white" id="optionsBtn" class="optionsBtn" onclick="toggleOptionMenu()">Options</button>
            </div>
        </header>

        <div id="input-container" style="width: 50%;">
            <div id="monaco-editor"></div>
            <div id="snippet-editor" style="display: none; height: 100%;"></div>
        </div>

        <div id="output-container" style="color: black; background-color:white; width: 50%;">

            <iframe id="output"></iframe>

            <div id="options-container" style="width: 50%; height: 100%; margin-top: 48px; display: none;">

                <div id="options">
                    <h4><b>Options</b></h4>
                    <p id="option1" onclick="toggleOption(1)" v="true" style="color: green">Alerts/Popups</p>
                    <p id="option4" onclick="toggleOption(4)" v="true" style="color: green">Dark Mode</p>   
                    <p id="option5" onclick="toggleOption(5)" v="true" style="color: green">Show Line Numbers</p>
                    <p id="option6" onclick="toggleOption(6)" v="true" style="color: green">Save & Auto Load Code</p>
                    <button style="color: white" onclick="font(-1)" id="dec">-</button><span id="span"> Font: 14 </span><button id="inc" style="color: white" onclick="font(1)">+</button>
                    <p id="option2" onclick="toggleOption(2)" v="true" style="color: green">Show Fullscreen Button</p>
                    <p id="option3" onclick="toggleOption(3)" v="true" style="color: green">Show Export Button</p>
                    <p id="option7" onclick="toggleOption(7)" v="true" style="color: green">Show Snippets Button</p>
                    <a id="noSnowA" style="color: red; text-decoration: none;" href="?doSnow=false">No Snow</a>
                    <!-- NEW-OPTION-CREATION -->
                    <br><br>
                    <button style="color: white" id="resetMonacoEditorValue" onclick="setMonacoEditorToDefault()">Reset Editor</button>
                    <br><br>
                    <button style="color: white" onclick="switchToBaseEditor()">Switch To Basic Editor</button>
                    <br><br>
                    <button style="color: white" onclick="resetOptions()">Reset Options</button>
                </div>

            </div>

            <div id="snippets-container" style="display: none; height: 95%; overflow-y: auto;">

                <h4>Snippets</h4>

                <div id="loadedSnippets"></div>

                <br>

                <div id="snippetButtonContainer">
                    <button id="editSnippetBtn" onclick="editSnippet();">Edit Snippet</button><button onclick="getSnippets();">Refresh</button><button onclick="createSnippet();">Create Snippet</button><br>
                    <button id="renameSnippetBtn" onclick="renameSnippet()">Rename Snippet</button> <button  id="closeSnippetBtn" onclick="closeSnippet();">Close Snippet</button><button onclick="uploadSnippet();">Upload Snippet</button>
                </div>

            </div>

        </div>
    </div>

    <script>
    
        let editor; // this is what holds the monaco editor 
        const output = document.getElementById('output'); // iframe output
        const inputContainer = document.getElementById('input-container'); // input container with monaco-editor (50% left side)
        const outputContainer = document.getElementById('output-container'); // output container with output (50% right side)
        const optionCount = 7; // [NEW-OPTION-CREATION] so for loops know how many times to loop (switched to loops instead of a bunch of if or switch case statements to keep this shorter in lines). 
        var doAlert = true; // do allow alerts, true by default  set to show alerts option value on load (toggleOption()).
        var isUsingMonacoEditor = false;   // prevents errors that can happen after switching to the basic editor caused by event listeners either attempting to interact with a deleted element or trying to update the output of the then deleted monaco editor.
        var isOriginalEditor = true; // if the original editor is deleted this is set to false.
        var isThereAnEditor = Boolean(document.getElementById("monaco-editor").firstChild == null); // if theres a element in monaco-editor / if theres an editor
        var getPreviousFileOnLoad = true; // gets previous file on load if this is true, if set to false in options this becomes false.
        var saveCodeOnUpdate = true; // if this is true then it saves code on update, if set to false in options this becomes false       save code automatically and load file on page load are one option(6).
        var createEditorOnLoad = true; // true by default, if false: its loads like normal
        var ignoreReturn = false; // ignore isusingmonacoeditor false -> return for the no editor alert so if createEditorOnLoad is false it shows the no editor alert
        var canUseRequire = null;  // for loaading monaco
        var canUseMonaco = false; // for loading monaco
        var isOptionsOpen = false;  // for preventing snippets from opening if options is open
        var isSnippetsOpen = false;  // for preventing options from opening if snippets is open
        var snippetMovedToEditor = null; // this is for storing what snippet was last loaded into the main editor from the snippet editor
        
        // ctrl+f "NEW-OPTION-CREATION" to find all things needed to be updated after creating a new option


        setInterval(() => {
            const editorContent = editor.getValue();
            localStorage.setItem('autosaveContent', editorContent);
            console.log('Content autosaved!');
        }, 5000); // Save every 5 seconds

        if(localStorage.getItem("snippets") == null) {
            var templateCode = '<!DOCTYPE html>\n<html>\n\n<head>\n    <title>Example</title>\n</head>\n\n<body>\n    <h1>Hello, World!</h1>\n    <p>Write some code!</p>\n</body>\n\n</html>';
            localStorage.setItem("snippets", "Example");
            localStorage.setItem("Example", templateCode);
        }

        function shareSnippet() {
            const snippetContent = monaco.editor.getEditors()[0].getValue(); 
            const encodedSnippet = encodeURIComponent(snippetContent); 
            const shareableLink = `${window.location.origin}${window.location.pathname}?snippet=${encodedSnippet}`;

            navigator.clipboard.writeText(shareableLink).then(() => {
                alert('Link copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy link:', err);
            });
        }
    
        document.getElementById('shareSnippet').addEventListener('click', shareSnippet);
    
        function loadSnippetFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const snippet = urlParams.get('snippet');
            if (snippet) {
                const decodedSnippet = decodeURIComponent(snippet); 
                monaco.editor.getEditors()[0].setValue(decodedSnippet);
            }
        }
    
        setInterval(loadSnippetFromURL, 3000);

        const url = new URL(window.location.href);
        const params = new URLSearchParams(url.search);

        try { // this is needed for monaco editor, it sets the vs path to the folder in Assets so it can be used as a variable when creating an editor
            require.config({
                paths: {
                    'vs': './assets/monaco-editor/0.52.2/min/vs/'
                }
            });
        } catch(err) {
            console.log("Main: require err!"); 
        }

        try {
            require(['vs/editor/editor.main'], function () {
                monaco;
            });
            gotMonaco=true;
        } catch(err) {
            gotMonaco = false;
            console.log("cant use 'monaco;'")
        }

        function scriptLoader() {
            //console.log("Main: script loader runned")
            if(gotMonaco) {
                doRun=true;
                console.log("Main: monaco editor loaded successfully")
            } else if(!(gotMonaco)) {
                doRun = false;
                createEditorOnLoad = false;
                document.getElementById("editor-container").style.display = "none";

                var scriptContainer = document.createElement("div");
                scriptContainer.id = "ScriptLoaderContainer";
                scriptContainer.style.display = "block";

                console.log("Main: missing file: Monaco Editor!");
                var meE = document.createElement("p");
                meE.id = "meE";
                meE.style.color = "red";
                meE.innerHTML = "Couldnt Load: Monaco Editor";
                scriptContainer.appendChild(meE);

                document.body.appendChild(scriptContainer);

            } else {
                doRun = true;
            }

        }

        scriptLoader();

        // -


        // - snippets code -
        function openSnippets() {

            var snippetContainer = document.getElementById("snippets-container");

            if(isOptionsOpen) {
                showAlert("Close snippets first.", 4000, false)
                return;
                // alert user: setTimeout -> set red text? gray text? then nack to white
            } 

            document.getElementById("snippet-editor").innerHTML = "<br><h4>select or create a snippet and it will appear here!<h4>";

            if(snippetContainer.style.display == "block") {
                // hide snippets
                isSnippetsOpen = false;
                for(c=0; c < monaco.editor.getEditors().length; c++) {
                    if(monaco.editor.getEditors()[c]._domElement.id == "snippet-editor") {
                        //var snippetCode = monaco.editor.getEditors()[c].getValue();
                        monaco.editor.getEditors()[c].dispose(); // dispose all snippet editors on snippet menu close
                    }
                }
                snippetContainer.style.display = "none"; // hide snippets
                document.getElementById("snippet-editor").style.display = "none";
                document.getElementById("monaco-editor").style.display = "block";
                output.hidden = false; // hide
                document.getElementById("snippetsBtn").innerText = "Snippets";
            } else {
                // show snippets
                updateOutput();
                isSnippetsOpen = true;
                snippetContainer.style.display = "block"; // show snippets
                document.getElementById("options-container").style.display = "none"; // hide options 
                document.getElementById("snippet-editor").style.display = "block";
                document.getElementById("monaco-editor").style.display = "none";
                output.hidden = true; // hide output
                document.getElementById("snippetsBtn").innerText = "Close Snippets";
                getSnippets();
            }

        }

        function getSnippets() {

            document.getElementById("loadedSnippets").innerHTML = "";

            var snippets = localStorage.getItem("snippets");
            var elements = [];

            
            if(snippets != null) {

                if(snippets == "") {
                    console.log("no snippets to get/load.")
                    var ns = document.createElement("b");
                    ns.innerText = "no snippets to load.";
                    document.getElementById("loadedSnippets").append(ns);
                    return;
                }

                var snippetsNameList = String(snippets).split(",");

                //console.log("snippets name list", snippetsNameList)

                for(f=0; f < snippetsNameList.length; f++) {
                    var selectedSnippet = snippetsNameList[f];

                    var selectedSnippetValue = localStorage.getItem(String(selectedSnippet));

                    if(selectedSnippetValue == null) {
                        console.log(`snippet '${selectedSnippet}' at index: ${f} is null, deleted.`);
                        var before = localStorage.getItem("snippets");
                        if(before.includes("," + selectedSnippet)) {
                            var after = before.replace(","+selectedSnippet, "");
                            console.log(`removing ',${selectedSnippet}' from snippets.`)
                            localStorage.setItem("snippets", after);
                        } else if(before.includes(selectedSnippet)) {
                            var after = before.replace(selectedSnippet, "");
                            console.log(`removing '${selectedSnippet}' from snippets.`)
                            localStorage.setItem("snippets", after);

                        } else {
                            console.log("snippet not found! snippet,snippet val,index", selectedSnippet, selctedSnippetValue, f)
                        }
                        document.getElementById("loadedSnippets").innerHTML = "";
                        setTimeout(function(){getSnippets();}, 2000);
                        return;
                    }

                    if(selectedSnippetValue == "") { // (!(selectedSnippetValue.includes("<html>")) && !(selectedSnippetValue.includes("</html>")))
                        console.log(`${selectedSnippet} is an empty snippet`)
                        var emptySnippetText = document.createElement("b");
                        var emptySnippetSpan = document.createElement("span");
                        emptySnippetSpan.textContent = `${selectedSnippet}.html (Empty)`;
                        emptySnippetSpan.setAttribute("onclick", `getASnippet("${selectedSnippet}")`);
                        var deleteSpan = document.createElement("span");
                        deleteSpan.textContent = "[Delete]";
                        deleteSpan.setAttribute("onclick", `deleteASnippet("${selectedSnippet}")`);
                        deleteSpan.style.color = "red";
                        emptySnippetText.appendChild(emptySnippetSpan);
                        emptySnippetText.appendChild(document.createTextNode(" | "));
                        emptySnippetText.appendChild(deleteSpan);
                        emptySnippetText.appendChild(document.createElement("br"));
                        elements.push(emptySnippetText);
                    } else {
                        console.log(`got snippet '${selectedSnippet}'.`)
                        var snippetText = document.createElement("b");
                        var snippetSpan = document.createElement("span");
                        snippetSpan.textContent = selectedSnippet;
                        snippetSpan.setAttribute("onclick", `getASnippet("${selectedSnippet}")`);
                        snippetText.appendChild(snippetSpan);
                        if(selectedSnippet != "Example") {
                            var deleteSpan = document.createElement("span");
                            deleteSpan.textContent = "[Delete]";
                            deleteSpan.setAttribute("onclick", `deleteASnippet("${selectedSnippet}")`);
                            deleteSpan.style.color = "red";
                            snippetText.appendChild(document.createTextNode(" | "));
                            snippetText.appendChild(deleteSpan);
                        }
                        snippetText.appendChild(document.createElement("br"));
                        elements.push(snippetText);
                    }

                }

                if(snippetsNameList.length > 0) { // if theres atleast 1 snippet
                    var top = document.createElement("p");
                    top.innerText = "-- loaded saved snippets --";
                    document.getElementById("loadedSnippets").append(top);
                    if(elements.length > 0) { // if theres snippets to load
                        for(g=0; g < elements.length; g++) {
                            document.getElementById("loadedSnippets").append(elements[g]);
                        }
                    }
                    var bottom = document.createElement("p");
                    bottom.innerText = "---------------------------";
                    document.getElementById("loadedSnippets").append(bottom);
                }
             
                showAlert("got snippets", 3500, false)

            } else {
                console.log("snippets is null")
            }

        }

        function getASnippet(snippetName) {

            for(o=0; o < monaco.editor.getEditors().length; o++) {
                    if(monaco.editor.getEditors()[o]._domElement.id == "snippet-editor") {
                        monaco.editor.getEditors()[o].dispose(); // dispose all snippet editors when making a new snippet editor
                    }
                }

            var gottenSnippet = localStorage.getItem(String(snippetName));

            if(gottenSnippet != null) {
                try {
                    require(['vs/editor/editor.main'], function () {
                        for(h=0; h < monaco.editor.getEditors(); h++) {
                            if(h._domElement == document.getElementById("snippet-editor")) {
                                // SHOULD ADD SAVE CHECK HERE
                                h.dispose(); // delete any old editor made through the snippet menu
                            }
                        }
                        document.getElementById("snippet-editor").innerHTML = "Snippet Loaded: <span id='loadedSnippetName'>" + snippetName + "</span>";
                        editor = monaco.editor.create(document.getElementById('snippet-editor'), {
                            value: String(gottenSnippet),
                            language: 'html',
                            theme: 'vs-dark',
                            readOnly: true,
                            automaticLayout: true,
                            minimap: {
                                enabled: false
                            }        
                        });
                        editor.onKeyDown((event) => {
                            showAlert("the snippet editor is read-only!", 3000, true);
                        });
                    });
                } catch(err) {
                    err;
                }
            }

        }

        function readOnlyLoop() {
            var editors = monaco.editor.getEditors();
            for(q=0; q < editors.length; q++) {
                if(editors[q]._domElement.id == "snippet-editor") {
                    editors[q].onKeyDown((event) => {
                        var alertText = "click edit snippet button to edit";
                        showAlert(alertText, 3000, true)
                    });
                }
            } 
        }

        setInterval(readOnlyLoop, 3000);

        function deleteASnippet(snippetName) {

            console.log("requested to delete snippet '" + snippetName + "'")

            const result = window.confirm(`delete snippet ${snippetName}?`);

            if(!(result)) {showAlert("canceled deletion.", 3000, false);return;}

            if(snippetName=="Example"){return;}

            if(localStorage.getItem(String(snippetName))!=null) {
                localStorage.removeItem(String(snippetName));
 
                // - for removing snippet from snippets (local storage variable) -
                var snippetsSplit = String(localStorage.getItem("snippets")).split(",");
                for(d=0; d < snippetsSplit.length; d++) {
                    if(snippetsSplit[f] === String(snippetName)) {
                        if(d > 0) { // index 0: SnippetName
                            localStorage.setItem("snippets", String(localStorage.getItem("snippets").replace(String(snippetName),""))); // remove snippet name from snippets using replace (local storage variable)
                        } else { // index 1+: ,SnippetName
                            localStorage.setItem("snippets", String(localStorage.getItem("snippets").replace(","+String(snippetName),""))); // remove ,snippet name from snippets using replace (local storage variable)

                        }
                    }
                }

                // - for removing snippet from snippets (local storage variable) -
        
                document.getElementById("snippet-editor").innerHTML = `<br><h4>snippet ${escapeHtml(snippetName)} was deleted...<h4>`;
                setTimeout(function() {
                    document.getElementById("snippet-editor").innerHTML = "<br><h4>select or create a snippet and it will appear here!<h4>";
                }, 2600);

                getSnippets();
            }
        }

        function closeSnippet() {
            try {
                for(l=0; l < monaco.editor.getEditors().length; l++) {
                    if(monaco.editor.getEditors()[l]._domElement == document.getElementById("snippet-editor")) {
                        monaco.editor.getEditors()[l].dispose(); // dispose all snippet editors on snippet menu close
                    }
                }
                
                var snippetName = document.getElementById("loadedSnippetName").innerText;
                document.getElementById("snippet-editor").innerHTML = `<br><h4>closed snippet ${escapeHtml(snippetName)}<h4>`;
                setTimeout(function() {
                    document.getElementById("snippet-editor").innerHTML = "<br><h4>select or create a snippet and it will appear here!<h4>";
                }, 2600);
            } catch(err) {
                if(String(err).includes("TypeError: Cannot read properties of null (reading 'innerText')")) {
                    showAlert("no snippet open to hide.") // handle loadedSnippetName being null (no loadedSnippetName = no snippet open)
                }
            }
        }


        function isValidSnippetName(name) {
            const invalidChars = /[<>:"/\\|?*\s]/; 
            const isEmpty = String(name).trim().length === 0;
            return !invalidChars.test(String(name)) && !isEmpty;
        }

        function createSnippet(code, name=null) {
            if(name==null) { // if name parameter is given set snippet name to the name param. instead of the prompt()
                var input = prompt("Snippet Name?");
            } else {
                input = String(name);
            }
            // parse input for special characters here!!!

            if(input == null) {
                console.log("canceled create snippet prompt");
                showAlert("canceled creation.", 3000, false);
                return;
            }

            if((!isValidSnippetName(name))) {
                showAlert("Invalid name!", 3000, false);
                return;
            }

            if(code == null) {
                code = `<html>\n \n <!-- {snippet: ${input}} -->\n \n </html>`;
            }
            
            // check for exsisting snippets with same name
            var isDuplicate = true;
            var snippetsSplit = localStorage.getItem("snippets").split(",");
            for(b=0; b < snippetsSplit.length; b++) {
                if(snippetsSplit[b] === String(input)) {
                    showAlert("snippet already exsists!", 3500, false);
                    console.log("cant create editor, snippet already exsist with name: " + String(input));
                    return;
                }
            }

            if(input != null && input != "") {
                localStorage.setItem(String(input), String(code));
                localStorage.setItem("snippets", String(localStorage.getItem("snippets")) + "," + String(input)); // update snippets name list so getSnippets knows to get the new snippet
                getSnippets();
                getASnippet(String(input));
            } else {
                console.log("snippet name is null or ''.")
            }
        }

        function getFile() {
            return new Promise((resolve, reject) => {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.style.display = 'none';
                document.body.appendChild(fileInput);
                fileInput.addEventListener('change', () => {
                    const file = fileInput.files[0];
                    document.body.removeChild(fileInput);
                    if (file) {
                        resolve(file);
                    } else {
                        reject(new Error('No file selected.'));
                    }
                });
                fileInput.click();
            });
        }

        function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(reader.error);
                reader.readAsText(file);
            });
        }
              
        function uploadSnippet() {
            try {
                (async function () {
                    try {
                        const file = await getFile(); 
                        const content = await readFileContent(file);
                        //console.log('File Content:', content);
                        if(String(file.name).includes(".html")) {
                            createSnippet(content, String(file.name).replace(".html", ""));
                            showAlert("created snippet with file", 4000, false);
                        } else {
                            showAlert("select a html file!", 4000, false);
                        }
                    } catch (err) {
                        console.error(err.message);
                        showAlert("cant upload snippet!", 4000, false);
                    }
                })();
            } catch(err) {
                console.log(err);
                showAlert("cant upload snippet!", 4000, false);
            }
        }

        function renameSnippet() {

            var snippetName = document.getElementById("loadedSnippetName").innerText;

            if(snippetName != null) {

                if(snippetName == "Example") {return;}

                var snippetToRename = localStorage.getItem(snippetName);

                if(snippetToRename != null) {

                    var newName = prompt("new snippet name?")
    
                    if(String(snippetToRename).includes(` <!-- {snippet: ${snippetName}} -->`)) {
                        String(snippetToRename).replace(` <!-- {snippet: ${snippetName} -->`,  ""); 
                    }

                    if(newName!=null) {
                        deleteASnippet(snippetName);
                        createSnippet(snippetToRename, String(newName));
                        showAlert("renamed snippet", 3000, false)
                    }

                } else {
                    console.log("snippetToRename == null");
                }

            } else {
                console.log("snippetName == null");
            }

        }

        setInterval(function() {
            if(document.getElementById("loadedSnippetName") != null) {
                document.getElementById("renameSnippetBtn").hidden = false;
                if(document.getElementById("loadedSnippetName").innerText == "Example") {document.getElementById("renameSnippetBtn").hidden = true;}
                document.getElementById("editSnippetBtn").hidden = false;  
                document.getElementById("closeSnippetBtn").hidden = false;
            } else {
                document.getElementById("editSnippetBtn").hidden = true;    
                document.getElementById("renameSnippetBtn").hidden = true;
                document.getElementById("closeSnippetBtn").hidden = true;
            }
        }, 0);

        function updateSnippetCode() {
            console.log("Code Saver/Loader: saving (snippet) editor code");
            
            var me = null;
            
            for(m=0; m < monaco.editor.getEditors().length; m++) {
                if(monaco.editor.getEditors()[m]._domElement.id == "monaco-editor") {   
                    me = monaco.editor.getEditors()[m];
                }
            }

            if(me != null) {
                if(snippetMovedToEditor != null) {
                    savePreviousFile();
                    var snippetName = snippetMovedToEditor;
                    if(snippetName == "Example") {return;}
                    if(localStorage.getItem(snippetName) != null) {
                        localStorage.setItem(snippetName, me.getValue());
                        showAlert("saved code & updated snippet code.")
                    }
                }
            }
        }

        function deleteAllSnippets() { // (besides example snippet)
        
        }

        function editSnippet() {

            var snippetNameSpan = document.getElementById("loadedSnippetName");

            if(snippetNameSpan != null) {

                var snippetName = snippetNameSpan.innerText;

                var snippetValue = localStorage.getItem(String(snippetName));

                var monacoEditor = null;
                var snippetEditor = null;

                if(snippetValue != null) {
                    
                    for(t=0; t < monaco.editor.getEditors().length; t++) {
                        if(monaco.editor.getEditors()[t]._domElement.id == "monaco-editor") {   
                            monacoEditor = monaco.editor.getEditors()[t];
                        } else if(monaco.editor.getEditors()[t]._domElement.id == "snippet-editor") {
                            snippetEditor = monaco.editor.getEditors()[t];
                        }
                    }

                    if(monacoEditor != null && snippetEditor != null) {
                        var saveMainEditorsCode = confirm(`save code you had before opening snippets and before loading '${snippetName}'?`);
                        if(saveMainEditorsCode) {
                            createSnippet(monacoEditor.getValue());
                        }
                        localStorage.setItem("codeBeforeSnippetEdit", monacoEditor.getValue())
                        monacoEditor.setValue(String(snippetValue));
                        if(isSnippetsOpen) {
                            openSnippets(); // (hide snippets)    
                            console.log("closed snippets")
                        }
                        showAlert(`opened snippet ${snippetName} in editor.`)
                        //console.log(`set monaco editor to value to: ${snippetValue}`)
                        snippetEditor.dispose();
                        console.log("disposed snippet editor")
                        snippetMovedToEditor = snippetName;
                        updateOutput();
                    } else {
                        console.log("monacoEditor and/or snippetEditor is null")
                    }
                    
            
                }


            } else {
                showAlert("no snippet loaded that can be edited")
            }

        }

        // ------------------ (end of snippet code)

        // Share / Receive Code Snippets
            function openShareMenu() {
                
                if(isSnippetsOpen) {
                    
                }

                if(isOptionOpen) {

                }

            } 
        // ----------------------------- (end of share code)

        function setMonacoEditorToDefault() {
            
            try {   
                deleteEditor(false);   
                // cannot read prop. of null error fix 
                // keeps editor div above <div class="context-view"> since without it, it causes errors since its targeting document.getElementById("monaco-editor").children[0] assuming its the editor div but it could the context view div causing errors so this just shuffles the divs to the right spot
                if(document.getElementById("monaco-editor") != null) {
                    for(e=0; e < document.getElementById("monaco-editor").children.length; e++) {
                        if(document.getElementById("monaco-editor").children[e].getAttribute("class") == "context-view") {
                            var otherdiv = document.getElementById("monaco-editor").children[e];
                            document.getElementById("monaco-editor").children[e].remove();
                            createEditor(true);
                            document.getElementById("monaco-editor").appendChild(otherdiv); 
                        } else {
                            createEditor(true);        
                        }
                    }
                }
                setTimeout(function() {savePreviousFile()}, 3000);
                console.log("Main: resetted editor")
            } catch(err){console.log(err)}

        }

        
        function deleteEditor(sta=true) { // sta = show the alert
            var editorList = monaco.editor.getEditors();
            for(a=0; a < editorList.length; a++) {
                monaco.editor.getEditors()[a].dispose();
            }
            if(editorList.length == 0) {
                if(!(sta)){return;}
                showAlert("no editor to delete", 5000, false);
            } else {
                if(!sta){return;}
                showAlert("deleted editor", 5000, false);
            }
            editor = null;
        }

        function createEditor(ol) { // ol = onload
            var templateCode = '<!DOCTYPE html>\n<html>\n\n<head>\n    <title>Example</title>\n</head>\n\n<body>\n    <h1>Hello, World!</h1>\n    <p>Write some code!</p>\n</body>\n\n</html>';
            if(getPreviousFileOnLoad) {
                templateCode = "";
            }
            if(ol) {
                // Monaco Editor (vs code in web)
                    require(['vs/editor/editor.main'], function () {
                        if(monaco.editor.getEditors().length == 1) {
                            deleteEditor(false); // this allows for a btn to reset the editor to the one that loads on load and if an editor exists already it deletes it.
                        }
                        editor = monaco.editor.create(document.getElementById('monaco-editor'), {
                            value: templateCode,
                            language: 'html',
                            theme: 'vs-dark',
                            automaticLayout: true,
                            minimap: {
                                enabled: false
                            }
                        });
                        
                        isUsingMonacoEditor = true;
                        
                    });
                // ------------------------------
            }
        }

        if(createEditorOnLoad) {    
            createEditor(true); // creates a monaco editor  createEditor(onload=true)
        } else {
            ignoreReturn = true;
        }
        
        function updateOutput(showAlertOnUpdate = true, save = true) {
            if (isUsingMonacoEditor) {
                try {
                    me = monaco.editor.getEditors()[0];
                    if(me == null) {return;}
                    const editor = me;
                    const code = me.getValue(); 
                    if (code.trim() !== "") {
                        const iframe = document.getElementById("output");

                        iframe.srcdoc = "";
                        iframe.srcdoc = code;

                        console.log("Main: updated output.");

                        if(snippetMovedToEditor != null) {

                            if(saveCodeOnUpdate && save) {
                                savePreviousFile(); // this saves the code in local storage variable previousFile
                            }

                            updateSnippetCode() // this saves the code in local storage variable ${snippetName} so for example you load a snippet and then start editing it when saving it will update the snippets code and will show updates in the snippets menu

                        } else {
                            if(saveCodeOnUpdate && save) { savePreviousFile(); }
                        }


                        if (showAlertOnUpdate) {
                            showAlert("updated output", 1000, false);
                        }
                    } else {
                        console.warn("Main: No code to update in iframe.");
                    }

                } catch (error) {
                    console.error("Main: Failed to update iframe output:", error);
                }
            }
        }

        let debounceTimer;
        if (editor) {
            editor.onDidChangeModelContent(() => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(updateOutput, 300); // Adjust delay as needed
            });
        }
        
        var fontSize = 14; // default
        
        function font(n, s=false) {

            if(s) {
                if(n>-1) {   
                    fontSize = n;
                }
            }

            if(String(n).includes("-")) {
                var before = String(document.getElementById("span").innerText);
                before = String(before).split(":")[1].replaceAll(" ", "");
                if(before == 1) {
                    document.getElementById("dec").style.color = "red";
                    setTimeout(function() {
                        document.getElementById("dec").style.color = "white";
                    }, 1700);
                    return;
                }
                //console.log("font is " + Number(before) + ", " + Number(before) + "-1 = " + (Number(before)-1) + "  setting font & span to: " + (Number(before)-1))
                fontSize = (Number(before)-1);
            } else if(!(String(n).includes("-"))){
                var before = String(document.getElementById("span").innerText);
                before = String(before).split(":")[1].replaceAll(" ", "");
                fontSize = (Number(before)+1);
            }

            monaco.editor.getEditors()[0].updateOptions({fontSize: fontSize})
            document.getElementById("span").innerText = ` Font: ${fontSize} `;
        };
        
        function switchToBaseEditor(delay=1000) {

            if(document.getElementById("ScriptLoaderContainer") != null && document.getElementById("ScriptLoaderContainer") == "")

            isUsingMonacoEditor = false;
            isOriginalEditor = false;
            setTimeout(function() {
                
                const result = window.confirm("do you want to switch to the basic editor?");
    
                if (result) {
                    const container = document.getElementById("alert-container");
                    container.style.zIndex = 11; // (+1 more than the header zIndex)
                    const alertElement = document.createElement("div");
                    alertElement.className = "alert-message";
                    alertElement.textContent = "switching to basic editor";
                    container.appendChild(alertElement);

                    if(document.getElementById("editor-container") != null) {document.getElementById("editor-container").remove();}

                    var baseEditorContainer = document.createElement("iframe");
                    baseEditorContainer.id = "baseEditor";
                    baseEditorContainer.srcdoc = "";
                    //document.getElementById("alertInPage").style.display = "none";
                    document.body.append(baseEditorContainer);
                    document.title = "html editor";
                    //document.getElementById("alertInPage").remove();
                    document.getElementById("alert-container").remove();
                    if(document.getElementsByClassName("monaco-aria-container")[0] != null) {
                        document.getElementsByClassName("monaco-aria-container")[0].remove();
                    }
                } else {
                    // canceled switch
                }
            }, delay);

        } // switch editor
    
        function showAlert(message="", ms=4000, removeOthers=false) {
            if(!(doAlert)) {
                return;
            }
            const container = document.getElementById("alert-container");
            container.style.zIndex = 1001; // (+1 more than the header zIndex)
            const alertElement = document.createElement("div");
            alertElement.className = "alert-message";
            alertElement.textContent = message;
            var removePreviousMessages = removeOthers;
            if(removePreviousMessages == true) {
                container.innerHTML = "";
            }
            container.appendChild(alertElement);
            setTimeout(() => {
                alertElement.remove();
            }, ms);

        }

        //  ----------------- SCRIPTS MOVED BACK INTO HTML  ----------------- 
        console.log("loaded options.")

        function resetOptions() {
            for (i=1; i <= optionCount; i++) {
                    const optionId = `option${i}`;
                    if(i==1||i==2||i==3||i==4||i==5) {  
                        // options that default to true   
                        localStorage.setItem(optionId, true);
                    } else if(false) {
                        // options that default to false (No options are false on default but i may create one in the future idk.)
                        //localStorage.setItem(optionId, false);
                    }
            }
            localStorage.setItem("fontSize", 14);
            checkForSavedOptions(true); // update
        }

        function saveOptions() {
            try {
                const options = {};

                for (j=1; j <= optionCount; j++) {
                    const optionId = `option${j}`;
                    const value = Boolean(document.getElementById(optionId).getAttribute('v'));
                    options[optionId] = value;
                    localStorage.setItem(optionId, value);
                }

                localStorage.setItem("fontSize", fontSize);

                const savedOptions = {
                    "alerts": options.option1,
                    "show fullscreen btn": options.option2,
                    "show export btn": options.option3,
                    "dark mode": options.option4,
                    "font size": fontSize,
                    "show line numbers": options.option5,
                    "auto save / load": options.option6,
                    "show snippets btn": options.option7,
                    // NEW-OPTION-CREATION

                };

                console.log("Options: saved options", savedOptions);
                showAlert("saved options", 4000, false);
            } catch (err) {
                showAlert("error saving options", 4000, false);
                console.log("error saving options: " + err)
            }
        }


        function checkForSavedOptions(isReset = false) {
            const savedOptions = {};

            for (k=1; k <= optionCount; k++) {
                savedOptions[`option${k}`] = localStorage.getItem(`option${k}`);
            }
            savedOptions.fontSize = localStorage.getItem("fontSize");

            if (savedOptions.option1 && savedOptions.option2 && savedOptions.option3 && savedOptions.option4 && savedOptions.option5 && savedOptions.option6 && savedOptions.option7 && savedOptions.fontSize) { // NEW-OPTION-CREATION
                const message = isReset ? "reset options." : "options loaded";
                showAlert(message, 3000, false);
            }

            console.log("Options: loading saved options.", savedOptions);

            for (let l = 1; l <= optionCount; l++) {
                const optionValue = savedOptions[`option${l}`];
                if (optionValue !== null) {
                    toggleOption(l, optionValue === "true");
                }
            }

            if (savedOptions.fontSize !== null) {
                monaco.editor.getEditors()[0].updateOptions({ fontSize: savedOptions.fontSize });
                fontSize = savedOptions.fontSize;
                document.getElementById("span").innerText = ` Font: ${fontSize} `;
            }
        }



        function toggleOptionMenu() {
            options = document.getElementById("options-container");
            if(isSnippetsOpen) {showAlert("Close snippets first.", 3000, false);return;}
            if(options.style.display == "block") {
                // hide options
                isOptionsOpen = false;
                options.style.display = "none";
                output.hidden = false;
                setTimeout(function() {updateOutput(false)}, 750);
                saveOptions();
                optionsBtn.innerText = "Options";
            } else {
                // show options
                isOptionsOpen = true;
                options.style.display = "block";
                output.hidden = true;
                //showAlert("showing options", 1500, true)
                optionsBtn.innerText = "Close Options";
            }
        };

        function toggleOption(option, v=null) { 
            // for loading previous options, toggleOption(1, true) sets option1 to true   if no value is given it just toggles it

            if(document.getElementById(`option${option}`) == null) {return;} // if option element not found dont try anything

            if(v == null) { // toggle
                // green if enabled / red if disabled
                if(document.getElementById(`option${option}`).style.color == "green") {
                    document.getElementById(`option${option}`).style.color = "red";   
                    document.getElementById(`option${option}`).setAttribute("v", "");
                } else if(document.getElementById(`option${option}`).style.color == "red"){
                    document.getElementById(`option${option}`).style.color = "green";
                    document.getElementById(`option${option}`).setAttribute("v", "true");
                }
            } else if(!(v == null)) { // set option to v(alue)
                if(v == true) {
                    document.getElementById(`option${option}`).style.color = "green";
                    document.getElementById(`option${option}`).setAttribute("v", "true");
                } else if(v == false) {
                    document.getElementById(`option${option}`).style.color = "red";   
                    document.getElementById(`option${option}`).setAttribute("v", "");
                }
            }

            // code for the options

            if(document.getElementById("option1").getAttribute("v") == "true") {
                doAlert = true;
            } else if(document.getElementById("option1").getAttribute("v") == ""){ 
                doAlert = false;
            }

            if(document.getElementById("option2").getAttribute("v") == "true") {
                fullscreenBtn.hidden = false;
            } else if(document.getElementById("option2").getAttribute("v") == ""){
                fullscreenBtn.hidden = true;
            }   

            if(document.getElementById("option3").getAttribute("v") == "true") {
                exportBtn.hidden = false;
            } else if(document.getElementById("option3").getAttribute("v") == ""){
                exportBtn.hidden = true;
            }

            if(document.getElementById("option4").getAttribute("v") == "true") {
                monaco.editor.setTheme("vs-dark");
            } else if(document.getElementById("option4").getAttribute("v") == ""){
                monaco.editor.setTheme("vs");
            }
            
            if(document.getElementById("option5").getAttribute("v") == "true") {
                monaco.editor.getEditors()[0].updateOptions({lineNumbers: true})
            } else if(document.getElementById("option5").getAttribute("v") == "") {
                monaco.editor.getEditors()[0].updateOptions({lineNumbers: false})
            }

            if(document.getElementById("option6").getAttribute("v") == "true") {
                getPreviousFileOnLoad = true;
                saveCodeOnUpdate = true;
            } else if(document.getElementById("option6").getAttribute("v") == "") {
                getPreviousFileOnLoad = false;
                saveCodeOnUpdate = false;
            }

            if(document.getElementById("option7").getAttribute("v") == "true") {
                document.getElementById("snippetsBtn").hidden = false;
            } else if(document.getElementById("option7").getAttribute("v") == "") {
                document.getElementById("snippetsBtn").hidden = true;
            }

            // NEW-OPTION-CREATION
            // this is the code for options, it handles what to do for each option by checking if its true or false and then it toggles the option for example showing or hiding a button
        }

        // - Above: Options - Below: CodeSaverLoader -
        
        console.log("loaded CodeSaveLoader.")

        if(scriptsLoaded != null) {
            scriptsLoaded.push("CodeSaverLoader");
        }

        function savePreviousFile() {
            try {
                var me = null;
                for(u=0; u < monaco.editor.getEditors().length; u++) {
                    if(monaco.editor.getEditors()[u]._domElement == document.getElementById("monaco-editor")) {
                        me = monaco.editor.getEditors()[u];
                    }
                }

                if(me != null) {
                    var lastInputFileValue = me.getValue();
                    //  lastInputFileValue = lastInputFileValue.replace(/\u00A0/g, ' ');
                    localStorage.setItem("lastFile", lastInputFileValue);
                    console.log("Saver/Loader: saved code.");
                } 

            } catch(err) {
                
                console.log("Saver/Loader: error saving code", err);

            }
        }

        function getPreviousFile() {
            try {
                var pF = localStorage.getItem("lastFile");
                if (pF != null && pF != "") {
                    setTimeout(function() {
                        if (editor != null) {
                            pF = pF.replace(/\u00A0/g, ' ');
                            editor.setValue(pF);
                            showAlert("code loaded", 2000, false);
                            console.log("Saver/Loader: got saved code.");
                        } 
                    }, 2000);
                }
            } catch(err) {
                console.log("Saver/Loader: error loading previous code", err)
            }
        }

        // - Above: CodeSaverLoader - Below: Export -

        console.log("loaded export.")

        if(scriptsLoaded != null) {
            scriptsLoaded.push("Export")
        }


        const save = (data, filename) => {
            const blob = new Blob([data], { type: "text/html" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            a.click();
        };

        function mkExport() {
            showAlert("attempting to export", 1000, false)
            console.log("Export: attempting to export")
            try {
                var exportCode = document.getElementById("monaco-editor").firstChild.firstChild.children[1].innerText;
                if(exportCode != "" || String(exportCode) != templateCode) {
                    console.log("Export: showing save file in os file manager")
                    save(exportCode, "output.html");
                } else {
                    console.log("Export: theres no code to export.")
                    showAlert("write some code before trying to export!", 3, false);
                }
            } catch(err) {
                if(document.getElementById("monaco-editor").firstChild == null) {      
                    setTimeout(function() {showAlert("no editor & no code to export.", 2000, false)}, 1100)
                } else {     
                    setTimeout(function() {showAlert("Error: cant export code", 2000, false)}, 1100)
                }
                console.log("err making export", err)
            }
        }
        // - Above: Export - Below: EventListeners -

        try {
            setTimeout( function() {

                console.log("loaded event listeners.")

                // --- event listeners ---

                document.addEventListener("keydown", function (event) {
                    try{
                        if(!(isUsingMonacoEditor)) {return;} 
                        if ((event.ctrlKey || event.metaKey) && event.key === "s") {
                            event.preventDefault();
                            if(isUsingMonacoEditor) {
                                updateOutput();
                            }
                        }
                    } catch(err) {
                        //console.log(err)
                    }
                });

                document.addEventListener("keydown", function (event) {
                    try {
                        if(!(isUsingMonacoEditor)) {return;} 
                        if (event.key == "Escape") {
                            event.preventDefault();
                            toggleOptionMenu();
                        }
                    } catch(err) {
                        //console.log(err)
                    }
                });

                setTimeout(function() {
                    try {
                        if(!(isUsingMonacoEditor)) {return;}
                        document.getElementById("output").contentWindow.document.body.addEventListener("keydown", function (event) {
                            if (event.key == "Escape") {
                                toggleOptionMenu();
                            }
                        });
                    } catch(err) {
                        //console.log(err)
                    }

                }, 5000);

                try {
                    const fullscreenBtn = document.getElementById('fullscreenBtn');
                    fullscreenBtn.addEventListener('click', () => {
                        const isFullscreen = inputContainer.style.display === 'none';
                        if (isFullscreen) {
                            inputContainer.style.display = 'flex';
                            fullscreenBtn.textContent = 'Full Screen';
                            outputContainer.style.flex = '1';
                        } else {
                            inputContainer.style.display = 'none';
                            fullscreenBtn.textContent = 'Exit Full Screen';
                            outputContainer.style.flex = 'none';
                            outputContainer.style.width = '100%';
                        }
                    });
                } catch(err) {
                    //console.log(err)
                }
                // -----------------------

            }, 2000); // setTimeout

        } catch(err) { // main event listeners try catch
            console.log("EventListeners: err", err)
        }

        //  -----------------------------------------------------------------

        setTimeout(function() {
            try {
                if(monaco && monaco.editor != null) {
                    checkForSavedOptions();
                }  
            } catch(err) {
                //console.log(err)
            }
        }, 1000);

        setTimeout(function() {
            updateOutput(false, false)
        }, 3000);

        
        if(getPreviousFileOnLoad) {
            try {
                getPreviousFile();
                setTimeout(function() {
                
                    if(editor != null) {
                        editor.getAction('editor.action.formatDocument').run();   
                    }

                }, 2000)
            } catch(err) {
                //console.log(err)
            }
        }
        
        // below snow overlay stuff below

        try {
            function doSnowCheck() {
                var doSnow = params.get("doSnow");

                if(doSnow == "false") {
                    console.log("parameter doSnow is false so snow wont start.")
                    document.getElementById("noSnowA").setAttribute("href", window.location.href.replace("?doSnow=false", ""));
                    document.getElementById("noSnowA").setAttribute("style", "color: green; text-decoration: none;");
                    document.getElementById("noSnowA").innerText = "No Snow";
                } else {
                    startSnowLoop();
                }
            }
            doSnowCheck();

            function startSnowLoop() {
                console.log("loaded so");

                var config = {
                    numberOfSnowflakes: 50,
                    interval: 900, // Interval between new snowflakes
                    sizeMin: 2, // Minimum size of snowflakes
                    sizeMax: 6, // Maximum size of snowflakes
                    durationMin: 5, // Minimum animation duration in seconds
                    durationMax: 8, // Maximum animation duration in seconds
                    delayMax: 5, // Maximum animation delay in seconds
                };

                let interval;


                function createSnowflake() {
                    const snowflake = document.createElement('div');
                    snowflake.classList.add('snowflake');
                    document.body.appendChild(snowflake);

                    const size = Math.random() * (config.sizeMax - config.sizeMin) + config.sizeMin; 
                    const startLeft = Math.random() * 100;
                    const animationDuration =
                        Math.random() * (config.durationMax - config.durationMin) + config.durationMin; 
                    const delay = Math.random() * config.delayMax; 

                    snowflake.style.width = `${size}px`;
                    snowflake.style.height = `${size}px`;
                    snowflake.style.left = `${startLeft}vw`;
                    snowflake.style.animationDuration = `${animationDuration}s`;
                    snowflake.style.animationDelay = `${delay}s`;

                    snowflake.addEventListener('animationend', () => {
                        snowflake.remove();
                    });
                }

                function createSnow() {
                    for (let i = 0; i < config.numberOfSnowflakes; i++) {
                        createSnowflake();
                    }
                }

                const today = new Date();
                const month = today.getMonth() + 1;

                if (month === 12) {
                    interval = setInterval(() => {
                        createSnowflake();
                    }, config.interval);
                    createSnow();
                }
            }
        } catch (err) {
            console.log("Couldn't load christmas snow overlay!", err);
        }

    </script>

</body>

</html>
