<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monaco HTML Editor</title>

    <!-- css stylesheets -->
    <link rel="stylesheet" href="./assets/css/styles.css"> <!-- main css for editor -->
    <!-- end of css -->

    <noscript>
        <style>
            .editor-container {
                display: none;
            }
        </style>
        <p>get a browser with javascript or re-enable js to use the editor.</p>
    </noscript>

    <script> // before loading / importing
        var scriptsLoaded = []; // scripts below use this variable so its needs to be defined before the scripts run.

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

    </script>

    <!-- scripts -->
        <script id="ScriptElement" src="./assets/monaco-editor/0.52.2/min/vs/loader.js"></script>   
        <script src="https://js.pusher.com/7.0/pusher.min.js"></script>
    <!-- end of scripts -->

</head>

<body class="body">

    <div id="alert-container"></div>

    <div id="editor-container" class="editor-container">

        <header id="header" class="top-bar">
            <span id="headerText" style="display: flex; gap: 6px; margin-left: 50%; margin-top: 4px;"></span>
            <div id="buttons">
                <button style="color: red" id="collabBtn" onclick="openCollabMenu()">Collab</button>
                <button style="color: green" id="shareBtn" onclick="openShareMenu()">Share</button>
                <button style="color: red" id="snippetsBtn" onclick="openSnippets()">Snippets</button>
                <button style="color: green" id="fullscreenBtn">Full Screen</button>
                <button style="color: red" id="exportBtn" onclick="mkExport()">Export</button>
                <button style="color: green" id="optionsBtn" class="optionsBtn" onclick="toggleOptionMenu()">Options</button>
            </div>
        </header>

        <div id="input-container" style="width: 50%;">
            <div id="monaco-editor"></div>
            <div id="snippet-editor" style="display: none; height: 100%;"></div>
        </div>

        <div id="output-container" style="color: black; background-color:white; width: 50%;">

            <iframe id="output"></iframe>

            <div id="options-container" style="height: 80%; width: 100%;  margin-top: 48px; display: none;">
                
                <b>Options</b>
                
                <div id="options" style="height: 100%; width: 100%; overflow: hidden; overflow-y: auto;">
                    <p id="option1" onclick="toggleOption(1)" v="true" style="color: green">Alerts/Popups</p>
                    <p id="option4" onclick="toggleOption(4)" v="true" style="color: green">Dark Mode</p>   
                    <p id="option5" onclick="toggleOption(5)" v="true" style="color: green">Show Line Numbers</p>
                    <p id="option6" onclick="toggleOption(6)" v="true" style="color: green">Save & Auto Load Code</p>
                    <button style="color: white" onclick="font(-1)" id="dec">-</button><span id="span"> Font: 14 </span><button id="inc" style="color: white" onclick="font(1)">+</button>
                    <p id="option2" onclick="toggleOption(2)" v="true" style="color: green">Show Fullscreen Button</p>
                    <p id="option3" onclick="toggleOption(3)" v="true" style="color: green">Show Export Button</p>
                    <p id="option7" onclick="toggleOption(7)" v="true" style="color: green">Show Snippets Button</p>
                    <p id="option8" onclick="toggleOption(8)" v="true" style="color: green">Show Share Button</p>
                    <p>option9 Show Collab Button</p>
                    <!-- NEW-OPTION-CREATION -->
                    <br><br>
                    <button style="color: white" id="resetMonacoEditorValue" onclick="setMonacoEditorToDefault()">Reset Editor</button>
                    <button style="color: white" onclick="switchToBaseEditor()">Switch To Basic Editor</button>
                    <button style="color: white" onclick="resetOptions()">Reset Options</button>
                </div>

            </div>

            <div id="snippets-container" style="display: none; height: 95%; overflow-y: auto;">

                <h4>Snippets</h4>

                <div id="loadedSnippets"></div>

                <br>

                <div id="snippetButtonContainer">
                    <button onclick="getSnippets();">Refresh</button>
                    <br>-
                    <button id="editSnippetBtn" onclick="editSnippet();">Edit Snippet</button><button onclick="createSnippet();">Create Snippet</button><br>
                    <button id="renameSnippetBtn" onclick="renameSnippet()">Rename Snippet</button> <button  id="closeSnippetBtn" onclick="closeSnippet();">Close Snippet</button>
                    <br><br>
                    <button onclick="uploadSnippet();">Upload Snippet</button>
                    <br>
                    <button style="color: red; background-color: black;"; onclick="deleteAllSnippets();">Delete All Snippets</button>
                    <br><br>
                </div>

            </div>


            <div id="shareMenu" style="display: none;">

                <h5>Share Code</h5>

                    <div id="ShareCodeFromSnippet" style="display: none;">
                        <h4>Choose A Snippet To Share:</h4>
                        <div id="snippetToShareList"></div>
                        <br>
                        <p id="copiedLinkSnippet" style="display: none;"></p>
                        <br><br>
                        <button onclick="shareSnippetBack()">Back</button>
                    </div>

                    <div id="shareButtons" style="display: none;">
                        <button onclick="shareCodeFromEditor()">Share code thats in editor</button>
                        <button onclick="shareCodeFromSnippet()">Share code from a snippet</button>
                        <div id="copiedLink" style="display: none"><br>you copied your share link!</div>
                    </div>

                </div>
                                      
            </div>

            <div id="collabMenu" style="display: none; height: 80%; width: 50%;  margin-top: 38px; display: none;">
                <span id="status" style="color: red">Disconnected</span>
                <div id="collabButtons">
                    <button style="color: black; background-color: lightgrey;" id="connectBtn">Connect To Server</button>
                    <br><br>
                    <span>Session: </span><span id="id" onclick="navigator.clipboard.writeText(String(this.innerText));showAlert('copied.', 4000, false)">None.</span>
                    <br><br>
                    <button id="createSessionBtn">Create Collab Session</button>
                    <button id="joinSessionBtn">Join Collab Session</button>
                    <span id="collabMessage" style="display: none;">connected and live updating.<br></span>
                    <br>
                    <button onclick="closeWebSocket()" id="closeWebSocketBtn">Close Collab</button>
                    <br><br>
                    <b>may be buggy or run into errors!</b>
                </div>
            </div>

        </div>
    </div>

    <script>
    
        let editor; // this is what holds the monaco editor 
        const output = document.getElementById('output'); // iframe output
        const inputContainer = document.getElementById('input-container'); // input container with monaco-editor (50% left side)
        const outputContainer = document.getElementById('output-container'); // output container with output (50% right side)
        const optionCount = 8; // [NEW-OPTION-CREATION] so for loops know how many times to loop (switched to loops instead of a bunch of if or switch case statements to keep this shorter in lines). 
        var doAlert = true; // do allow alerts, true by default  set to show alerts option value on load (toggleOption()).
        var isUsingMonacoEditor = false;   // prevents errors that can happen after switching to the basic editor caused by event listeners either attempting to interact with a deleted element or trying to update the output of the then deleted monaco editor.
        var isOriginalEditor = true; // if the original editor is deleted this is set to false.
        var isThereAnEditor = Boolean(document.getElementById("monaco-editor").firstChild == null); // if theres a element in monaco-editor / if theres an editor
        var getPreviousFileOnLoad = true; // gets previous file on load if this is true, if set to false in options this becomes false.
        var saveCodeOnUpdate = true; // if this is true then it saves code on update, if set to false in options this becomes false       save code automatically and load file on page load are one option(6).
        var createEditorOnLoad = true; // true by default, if false: its loads like normal
        var ignoreReturn = false; // ignore isusingmonacoeditor false -> return for the no editor alert so if createEditorOnLoad is false it shows the no editor alert
        var canUseRequire = null;  // for loaading monaco
        var canUseMonaco = false; // for loading monaco
        var isOptionsOpen = false;  // if options is open dont allow snippets or share menu to open
        var isSnippetsOpen = false;  // if snippets is open dont allow options or share menu to open
        var isShareMenuOpen = false; // if share menu is open dont allow snippets or options menu to open
        var isCollabMenuOpen = false; // if collab menu is open dont allow snippets, options, or share menu to open
        var snippetMovedToEditor = null; // this is for storing what snippet was last loaded into the main editor from the snippet editor
        var detectIfPreviousFileIsASnippetAndLoadSnippet = false;
        let socket = null;
        let currentSessionId = null;
        let debounceTimeout = null;

        // ctrl+f "NEW-OPTION-CREATION" to find all things needed to be updated after creating a new option

        if(localStorage.getItem("snippets") == null) { // set snippets to example on first time visiting (or just if its null)
            var templateCode = '<!DOCTYPE html>\n<html>\n\n<head>\n    <title>Example</title>\n</head>\n\n<body>\n    <h1>Hello, World!</h1>\n    <p>Write some code!</p>\n</body>\n\n</html>';
            localStorage.setItem("snippets", "Example");
            localStorage.setItem("Example", templateCode);
        }

        //const url = new URL(window.location.href);
        //const params = new URLSearchParams(url.search);

        try { // this is needed for monaco editor, it sets the vs path to the folder in Assets so it can be used as a variable when creating an editor
            require.config({
                paths: {
                    'vs': './assets/monaco-editor/0.52.2/min/vs/'
                }
            });
        } catch(err) {
            console.log("Main: require err!"); 
        }

        try { // also for monaco editor, detects if monaco is loaded and can be used.
            require(['vs/editor/editor.main'], function () {
                monaco;
            });
            gotMonaco=true;
        } catch(err) {
            gotMonaco = false;
            console.log("cant use 'monaco;'")
        }

        function scriptLoader() { // loads monaco editor
            console.log("Main: script loader runned")
            if(gotMonaco) {
                doRun=true;
                console.log("Main: monaco editor loaded successfully")
            } else if(!(gotMonaco)) {
                doRun = false;
                createEditorOnLoad = false;
                document.getElementById("editor-container").style.display = "none";

                var scriptContainer = document.createElement("div");
                scriptContainer.id = "ScriptLoaderContainer";
                scriptContainer.style.display = "block";

                console.log("Main: missing file: Monaco Editor!");
                var meE = document.createElement("p");
                meE.id = "meE";
                meE.style.color = "red";
                meE.innerHTML = "Couldnt Load: Monaco Editor";
                scriptContainer.appendChild(meE);

                document.body.appendChild(scriptContainer);

            } else {
                doRun = true;
            }

        }

        scriptLoader();

        // -
        
        // - snippets code -
        function openSnippets() { // open (toggle) snippets menu

            var snippetContainer = document.getElementById("snippets-container");

            if(isOptionsOpen) {
                showAlert("Close snippets first.", 4000, false)
                return;
            } 

            if(isShareMenuOpen) {
                showAlert("Close share menu first.", 4000, false)
                return;
            } 

            if(isCollabMenuOpen) {
                showAlert("Close collab menu first.", 4000, false)
                return;
            }

            document.getElementById("snippet-editor").innerHTML = "<br><h4>select or create a snippet and it will appear here!<h4>";

            if(snippetContainer.style.display == "block") {
                // hide snippets
                isSnippetsOpen = false;
                for(c=0; c < monaco.editor.getEditors().length; c++) {
                    if(monaco.editor.getEditors()[c]._domElement.id == "snippet-editor") {
                        //var snippetCode = monaco.editor.getEditors()[c].getValue();
                        monaco.editor.getEditors()[c].dispose(); // dispose all snippet editors on snippet menu close
                    }
                }
                snippetContainer.style.display = "none"; // hide snippets
                document.getElementById("snippet-editor").style.display = "none";
                document.getElementById("monaco-editor").style.display = "block";
                output.hidden = false; // hide
                document.getElementById("snippetsBtn").innerText = "Snippets";
            } else {
                // show snippets
                updateOutput();
                isSnippetsOpen = true;
                snippetContainer.style.display = "block"; // show snippets
                document.getElementById("options-container").style.display = "none"; // hide options 
                document.getElementById("snippet-editor").style.display = "block";
                document.getElementById("monaco-editor").style.display = "none";
                output.hidden = true; // hide output
                document.getElementById("snippetsBtn").innerText = "Close Snippets";
                getSnippets();
            }

        }

        function getSnippets() {

            document.getElementById("loadedSnippets").innerHTML = "";

            var snippets = localStorage.getItem("snippets");
            var elements = [];

            
            if(snippets != null) {

                if(snippets == "") {
                    console.log("no snippets to get/load.")
                    var ns = document.createElement("b");
                    ns.innerText = "no snippets to load.";
                    document.getElementById("loadedSnippets").append(ns);
                    return;
                }

                var snippetsNameList = String(snippets).split(",");

                //console.log("snippets name list", snippetsNameList)

                for(f=0; f < snippetsNameList.length; f++) {
                    var selectedSnippet = snippetsNameList[f];

                    var selectedSnippetValue = localStorage.getItem(String(selectedSnippet));

                    if(selectedSnippetValue == null) {
                        console.log(`snippet '${escapeHtml(selectedSnippet)}' at index: ${f} is null, deleted.`);
                        var before = localStorage.getItem("snippets");
                        if(before.includes("," + selectedSnippet)) {
                            var after = before.replace(","+selectedSnippet, "");
                            console.log(`removing ',${escapeHtml(selectedSnippet)}' from snippets.`)
                            localStorage.setItem("snippets", after);
                        } else if(before.includes(selectedSnippet)) {
                            var after = before.replace(selectedSnippet, "");
                            console.log(`removing '${escapeHtml(selectedSnippet)}' from snippets.`)
                            localStorage.setItem("snippets", after);

                        } else {
                            console.log("snippet not found! snippet,snippet val,index", selectedSnippet, selctedSnippetValue, f)
                        }
                        document.getElementById("loadedSnippets").innerHTML = "";
                        setTimeout(function(){getSnippets();}, 2000);
                        return;
                    }

                    if(selectedSnippetValue == "") { 
                        console.log(`${escapeHtml(selectedSnippet)} is an empty snippet`)
                        var emptySnippetText = document.createElement("b");
                        emptySnippetText.innerHTML = `<span onclick='getASnippet("${escapeHtml(selectedSnippet)}")'>${escapeHtml(selectedSnippet)}.html (Empty)</span>&nbsp;&nbsp;|&nbsp;&nbsp;<span onclick='deleteASnippet("${escapeHtml(selectedSnippet)}")' style='color: red;'>[Delete]</span><br>`;
                        elements.push(emptySnippetText);
                    } else {
                        console.log(`got snippet '${escapeHtml(selectedSnippet)}'.`)
                        var snippetText = document.createElement("b");
                        if(selectedSnippet == "Example") { 
                            snippetText.innerHTML = `<span onclick='getASnippet("${escapeHtml(selectedSnippet)}")'>${escapeHtml(selectedSnippet)}</span><br>`;
                        } else {
                            snippetText.innerHTML = `<span onclick='getASnippet("${escapeHtml(selectedSnippet)}")'>${escapeHtml(selectedSnippet)}.html</span>&nbsp;&nbsp;|&nbsp;&nbsp;<span onclick='deleteASnippet("${escapeHtml(selectedSnippet)}")' style='color: red;'>[Delete]</span><br>`;
                        }
                        elements.push(snippetText);
                    }

                }

                if(snippetsNameList.length > 0) { // if theres atleast 1 snippet
                    var top = document.createElement("p");
                    top.innerText = "-- loaded saved snippets --";
                    document.getElementById("loadedSnippets").append(top);
                    if(elements.length > 0) { // if theres snippets to load
                        for(g=0; g < elements.length; g++) {
                            document.getElementById("loadedSnippets").append(elements[g]);
                        }
                    }
                    var bottom = document.createElement("p");
                    bottom.innerText = "---------------------------";
                    document.getElementById("loadedSnippets").append(bottom);
                }
             
                showAlert("got snippets", 3500, false)

            } else {
                console.log("snippets is null")
            }

        }

        function getASnippet(snippetName) {

            for(o=0; o < monaco.editor.getEditors().length; o++) {
                    if(monaco.editor.getEditors()[o]._domElement.id == "snippet-editor") {
                        monaco.editor.getEditors()[o].dispose(); // dispose all snippet editors when making a new snippet editor
                    }
                }

            var gottenSnippet = localStorage.getItem(String(snippetName));

            if(gottenSnippet != null) {
                try {
                    require(['vs/editor/editor.main'], function () {
                        for(h=0; h < monaco.editor.getEditors(); h++) {
                            if(h._domElement == document.getElementById("snippet-editor")) {
                                // SHOULD ADD SAVE CHECK HERE
                                h.dispose(); // delete any old editor made through the snippet menu
                            }
                        }
                        document.getElementById("snippet-editor").innerHTML = "Snippet Loaded: <span id='loadedSnippetName'>" + escapeHtml(snippetName) + "</span>";
                        editor = monaco.editor.create(document.getElementById('snippet-editor'), {
                            value: String(gottenSnippet),
                            language: 'html',
                            theme: 'vs-dark',
                            readOnly: true,
                            automaticLayout: true,
                            minimap: {
                                enabled: false
                            }        
                        });
                        editor.onKeyDown((event) => {
                            showAlert("the snippet editor is read-only!", 3000, true);
                        });
                    });
                } catch(err) {
                    err;
                }
            }

        }

        function readOnlyLoop() {
            var editors = monaco.editor.getEditors();
            for(q=0; q < editors.length; q++) {
                if(editors[q]._domElement.id == "snippet-editor") {
                    editors[q].onKeyDown((event) => {
                        var alertText = "click edit snippet button to edit";
                        showAlert(alertText, 3000, true)
                    });
                }
            } 
        }

        setInterval(readOnlyLoop, 3000);

        function dontHaveEmpty() {
            try {
                var editorCode = monaco.editor.getEditors()[0].getValue();
                if(monaco.editor.getEditors()[0] != null) {
                    if(editorCode == "") {
                        monaco.editor.getEditors()[0].setValue("<html>\n\n</html>");
                    }
                }
            } catch(err) {
                err;
            }
        }

        setInterval(dontHaveEmpty, 3000);

        function deleteASnippet(snippetName) {

            console.log("requested to delete snippet '" + snippetName + "'")

            const result = window.confirm(`delete snippet ${snippetName}?`);

            if(!(result)) {showAlert("canceled deletion.", 3000, false);return;}

            if(snippetName=="Example"){return;}

            if(localStorage.getItem(String(snippetName))!=null) {
                localStorage.removeItem(String(snippetName));
 
                // - for removing snippet from snippets (local storage variable) -
                var snippetsSplit = String(localStorage.getItem("snippets")).split(",");
                for(d=0; d < snippetsSplit.length; d++) {
                    if(snippetsSplit[f] === String(snippetName)) {
                        if(d > 0) { // index 0: SnippetName
                            localStorage.setItem("snippets", String(localStorage.getItem("snippets").replace(String(snippetName),""))); // remove snippet name from snippets using replace (local storage variable)
                        } else { // index 1+: ,SnippetName
                            localStorage.setItem("snippets", String(localStorage.getItem("snippets").replace(","+String(snippetName),""))); // remove ,snippet name from snippets using replace (local storage variable)

                        }
                    }
                }

                // - for removing snippet from snippets (local storage variable) -
        
                document.getElementById("snippet-editor").innerHTML = `<br><h4>snippet ${escapeHtml(snippetName)} was deleted...<h4>`;
                setTimeout(function() {
                    document.getElementById("snippet-editor").innerHTML = "<br><h4>select or create a snippet and it will appear here!<h4>";
                }, 2600);

                getSnippets();
            }
        }

        function closeSnippet() {
            try {
                for(l=0; l < monaco.editor.getEditors().length; l++) {
                    if(monaco.editor.getEditors()[l]._domElement == document.getElementById("snippet-editor")) {
                        monaco.editor.getEditors()[l].dispose(); // dispose all snippet editors on snippet menu close
                    }
                }
                
                var snippetName = document.getElementById("loadedSnippetName").innerText;
                document.getElementById("snippet-editor").innerHTML = `<br><h4>closed snippet: ${escapeHtml(snippetName)}<h4>`;
                setTimeout(function() {
                    document.getElementById("snippet-editor").innerHTML = "<br><h4>select or create a snippet and it will appear here!<h4>";
                }, 2600);
            } catch(err) {
                if(String(err).includes("TypeError: Cannot read properties of null (reading 'innerText')")) {
                    showAlert("no snippet open to hide.") // handle loadedSnippetName being null (no loadedSnippetName = no snippet open)
                }
            }
        }

        function isValidSnippetName(name) {
            const invalidChars = /[<>:"/\\|?*\s]/; 
            const isEmpty = String(name).trim().length === 0;
            return !invalidChars.test(String(name)) && !isEmpty;
        }

        function createSnippet(code, name=null) {
            if(name==null) { // if name parameter is given set snippet name to the name param. instead of the prompt()
                var input = prompt("Snippet Name?");
            } else {
                input = String(name);
            }
            // parse input for special characters here!!!

            if(input == null) {
                console.log("canceled create snippet prompt");
                showAlert("canceled creation.", 3000, false);
                return;
            }

            if((!isValidSnippetName(name))) {
                showAlert("Invalid name!", 3000, false);
                return;
            }

            if(code == null) {
                code = `<html>\n \n <!-- {snippet: ${input}} -->\n \n </html>`;
            }
            
            // check for exsisting snippets with same name
            var isDuplicate = true;
            var snippetsSplit = localStorage.getItem("snippets").split(",");
            for(b=0; b < snippetsSplit.length; b++) {
                if(snippetsSplit[b] === String(input)) {
                    showAlert("snippet already exsists!", 3500, false);
                    console.log("cant create editor, snippet already exsist with name: " + String(input));
                    return;
                }
            }

            if(input != null && input != "") {
                localStorage.setItem(String(input), String(code));
                localStorage.setItem("snippets", String(localStorage.getItem("snippets")) + "," + String(input)); // update snippets name list so getSnippets knows to get the new snippet
                getSnippets();
                getASnippet(String(input));
            } else {
                console.log("snippet name is null or ''.")
            }
        }

        function getFile() {
            return new Promise((resolve, reject) => {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.style.display = 'none';
                document.body.appendChild(fileInput);
                fileInput.addEventListener('change', () => {
                    const file = fileInput.files[0];
                    document.body.removeChild(fileInput);
                    if (file) {
                        resolve(file);
                    } else {
                        reject(new Error('No file selected.'));
                    }
                });
                fileInput.click();
            });
        }

        function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(reader.error);
                reader.readAsText(file);
            });
        }
              
        function uploadSnippet() {
            try {
                (async function () {
                    try {
                        const file = await getFile(); 
                        const content = await readFileContent(file);
                        //console.log('File Content:', content);
                        if(String(file.name).includes(".html")) {
                            createSnippet(content, String(file.name).replace(".html", ""));
                            showAlert("created snippet with file", 4000, false);
                        } else {
                            showAlert("select a html file!", 4000, false);
                        }
                    } catch (err) {
                        console.error(err.message);
                        showAlert("cant upload snippet!", 4000, false);
                    }
                })();
            } catch(err) {
                console.log(err);
                showAlert("cant upload snippet!", 4000, false);
            }
        }

        function renameSnippet() {

            var snippetName = document.getElementById("loadedSnippetName").innerText;

            if(snippetName != null) {

                if(snippetName == "Example") {return;}

                var snippetToRename = localStorage.getItem(snippetName);

                if(snippetToRename != null) {

                    var newName = prompt("new snippet name?")
    
                    if(String(snippetToRename).includes(` <!-- {snippet: ${snippetName}} -->`)) {
                        String(snippetToRename).replace(` <!-- {snippet: ${snippetName} -->`,  ""); 
                    }

                    if(newName!=null) {
                        deleteASnippet(snippetName);
                        createSnippet(snippetToRename, String(newName));
                        showAlert("renamed snippet", 3000, false)
                    }

                } else {
                    console.log("snippetToRename == null");
                }

            } else {
                console.log("snippetName == null");
            }

        }

        setInterval(function() {
            try {
                if(document.getElementById("loadedSnippetName") != null) {
                    document.getElementById("renameSnippetBtn").hidden = false;
                    if(document.getElementById("loadedSnippetName").innerText == "Example") {document.getElementById("renameSnippetBtn").hidden = true;}
                    document.getElementById("editSnippetBtn").hidden = false;  
                    document.getElementById("closeSnippetBtn").hidden = false;
                } else {
                    document.getElementById("editSnippetBtn").hidden = true;    
                    document.getElementById("renameSnippetBtn").hidden = true;
                    document.getElementById("closeSnippetBtn").hidden = true;
                }
            } catch(err) {

            }
        }, 0);

        function updateSnippetCode() {
            console.log("Code Saver/Loader: saving (snippet) editor code");
            
            var me = null;
            
            for(m=0; m < monaco.editor.getEditors().length; m++) {
                if(monaco.editor.getEditors()[m]._domElement.id == "monaco-editor") {   
                    me = monaco.editor.getEditors()[m];
                }
            }

            if(me != null) {
                if(snippetMovedToEditor != null) {
                    savePreviousFile();
                    var snippetName = snippetMovedToEditor;
                    if(snippetName == "Example") {return;}
                    if(localStorage.getItem(snippetName) != null) {
                        localStorage.setItem(snippetName, me.getValue());
                        showAlert("saved code & updated snippet code.")
                    }
                }
            }
        }

        function deleteAllSnippets() { // (besides example snippet)

            var confirmDelete = confirm("delete all snippets? you CANT undo this action!");

            if(!(confirmDelete)) {
                showAlert("canceled deletion of all snippets.", 4000, false);
                return;
            }

            var snippets = localStorage.getItem("snippets");
            var snippetsSplit = snippets.split(",");

            for(i=0; i < snippetsSplit.length; i++) {
                if(snippetsSplit[i] != "Example") {
                    localStorage.removeItem(snippetsSplit[i]);
                }
            }

            localStorage.setItem("snippets", "Example");
            getSnippets();
            showAlert("deleted all snippets.", 4000, false);

        }

        function editSnippet(name=null, noPrompt=null) {

            var snippetNameSpan = document.getElementById("loadedSnippetName");
  
            if(snippetNameSpan != null) {
                if(name == null) {
                    var snippetName = snippetNameSpan.innerText;
                } else {
                    var snippetName = name;
                }


                var snippetValue = localStorage.getItem(String(snippetName));

                var monacoEditor = null;
                var snippetEditor = null;

                if(snippetValue != null) {
                    
                    for(t=0; t < monaco.editor.getEditors().length; t++) {
                        if(monaco.editor.getEditors()[t]._domElement.id == "monaco-editor") {   
                            monacoEditor = monaco.editor.getEditors()[t];
                        } else if(monaco.editor.getEditors()[t]._domElement.id == "snippet-editor") {
                            snippetEditor = monaco.editor.getEditors()[t];
                        }
                    }

                    if(monacoEditor != null && snippetEditor != null) {
                        if(!(noPrompt)) {
                            var saveMainEditorsCode = confirm(`save code you had before opening snippets and before loading '${snippetName}'?`);
                            if(saveMainEditorsCode) {
                                createSnippet(monacoEditor.getValue());
                            }
                        }
                        localStorage.setItem("codeBeforeSnippetEdit", monacoEditor.getValue())
                        monacoEditor.setValue(String(snippetValue));
                        if(isSnippetsOpen) {
                            openSnippets(); // (hide snippets)    
                            console.log("closed snippets")
                        }
                        showAlert(`opened snippet ${snippetName} in editor.`)
                        //console.log(`set monaco editor to value to: ${snippetValue}`)
                        snippetEditor.dispose();
                        console.log("disposed snippet editor")
                        snippetMovedToEditor = snippetName;
                        updateOutput();
                    } else {
                        console.log("monacoEditor and/or snippetEditor is null")
                    }
                    
            
                }


            } else {
                showAlert("no snippet loaded that can be edited")
            }

        }


        // ------------------ (end of snippet code)
   

        // Share / Receive Code Snippets
            function openShareMenu() {
                
                if(isSnippetsOpen){showAlert("Close snippets first.", 4000, false);return;}
                if(isOptionsOpen){showAlert("Close options first.", 4000, false);return;}

                var shareMenu = document.getElementById("shareMenu");

                if(shareMenu.style.display == "block") {
                    isShareMenuOpen = false;
                    console.log("hiding share menu")
                    shareMenu.style.display = "none";
                    document.getElementById("shareButtons").style.display = "none";
                    output.hidden = false;
                    document.getElementById("shareBtn").innerText = "Share";
                } else {
                    isShareMenuOpen = true;
                    console.log("showing share menu")
                    shareMenu.style.display = "block";
                    document.getElementById("shareButtons").style.display = "block";
                    output.hidden = true;
                    document.getElementById("shareBtn").innerText = "Close Share Menu";
                }

            } 

            function copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    console.log('share url copied to clipboard');
                    showAlert("copied share link to clipboard", 3000, false);
                }).catch(err => {
                    console.error('Failed to copy text:', err);
                });
            }

            function shareCodeFromEditor() {
                var c = confirm("create snippet using code on the left?");
                if(c) {
                    var p = document.getElementById("copiedLink");
                    p.style.display = "none";
                    var snippetContent = monaco.editor.getEditors()[0].getValue(); 
                    var encodedSnippet = encodeURIComponent(snippetContent); 
                    var shareableLink = `${window.location.origin}${window.location.pathname}?snippet=${encodedSnippet}`;
                    copyToClipboard(shareableLink);
                    p.innerHTML = `<br> copied link. <br><br> <a href='' onclick='window.open("${shareableLink}")'>Open Link</a>`;
                    p.style.display = "block";

                }
            }

            function shareSnippetBack() {
                document.getElementById("ShareCodeFromSnippet").style.display = "none";
                document.getElementById("shareButtons").style.display = "block";
            }

            function doSnippetSharing(snippetName) {
                console.log("snippet name: " + snippetName)
                document.getElementById("copiedLinkSnippet").innerText = "";
                document.getElementById("copiedLinkSnippet").style.display = "none";
                var snippetValue = localStorage.getItem(snippetName);
                //var snippetContent = monaco.editor.getEditors()[0].getValue(); 
                if(snippetValue != null) {
                    const encodedSnippet = encodeURIComponent(snippetValue); 
                    const shareableLink = `${window.location.origin}${window.location.pathname}?snippet=${encodedSnippet}`;
                    copyToClipboard(shareableLink);
                    document.getElementById("copiedLinkSnippet").style.display = "block";                      // <a onclick='window.open("${snippetLink}")'>a element</a>
                    document.getElementById("copiedLinkSnippet").innerHTML = `copied link for snippet: ${escapeHtml(snippetName)} <br><br> <a href="" onclick="window.open('${shareableLink}')">Open Link</a>`;
                } else {
                    console.log("snippet is null")
                }
            }

            function shareCodeFromSnippet() {
                // get snippets and let user choose one to share

                document.getElementById("ShareCodeFromSnippet").style.display = "block";
                document.getElementById("shareButtons").style.display = "none";

                // pasted from getSnippets() and modified.
                document.getElementById("snippetToShareList").innerHTML = "";

                var snippets = localStorage.getItem("snippets");
                var elements = [];

                if(snippets != null) {

                    if(snippets == "") {
                        console.log("no snippets to get/load.")
                        var ns = document.createElement("b");
                        ns.innerText = "no snippets to load.";
                        document.getElementById("snippetToShareList").append(ns);
                        return;
                    }

                    var snippetsNameList = String(snippets).split(",");

                    for(f=0; f < snippetsNameList.length; f++) {
                        var selectedSnippet = snippetsNameList[f];

                        var selectedSnippetValue = localStorage.getItem(String(selectedSnippet));

                        if(selectedSnippetValue == null) {
                            console.log(`snippet '${escapeHtml(selectedSnippet)}' at index: ${f} is null, deleted.`);
                            var before = localStorage.getItem("snippets");
                            if(before.includes("," + selectedSnippet)) {
                                var after = before.replace(","+selectedSnippet, "");
                                console.log(`removing ',${escapeHtml(selectedSnippet)}' from snippets.`)
                                localStorage.setItem("snippets", after);
                            } else if(before.includes(selectedSnippet)) {
                                var after = before.replace(selectedSnippet, "");
                                console.log(`removing '${escapeHtml(selectedSnippet)}' from snippets.`)
                                localStorage.setItem("snippets", after);

                            } else {
                                console.log("snippet not found! snippet,snippet val,index", selectedSnippet, selctedSnippetValue, f)
                            }
                            document.getElementById("snippetToShareList").innerHTML = "";
                            setTimeout(function(){shareCodeFromSnippet();}, 2000);
                            return;
                        }

                        if(selectedSnippetValue == "") { // (!(selectedSnippetValue.includes("<html>")) && !(selectedSnippetValue.includes("</html>")))
                            console.log(`${escapeHtml(selectedSnippet)} is an empty snippet`)
                            var emptySnippetText = document.createElement("b");
                            emptySnippetText.innerHTML = ``;
                            elements.push(emptySnippetText);
                        } else {
                            console.log(`got snippet '${escapeHtml(selectedSnippet)}'.`)
                            var snippetText = document.createElement("b");
                            if(selectedSnippet == "Example") { 
                                snippetText.innerHTML = `<span onclick='doSnippetSharing("Example")'>Example</span><br>`;
                            } else {
                                snippetText.innerHTML = `<span onclick='doSnippetSharing("${escapeHtml(selectedSnippet)}")'>${escapeHtml(selectedSnippet)}</span><br>`;
                            }
                            elements.push(snippetText);
                        }

                    }

                    if(snippetsNameList.length > 0) { // if theres atleast 1 snippet
                        var top = document.createElement("p");
                        top.innerText = "------------------";
                        document.getElementById("snippetToShareList").append(top);
                        if(elements.length > 0) { // if theres snippets to load
                            for(g=0; g < elements.length; g++) {
                                document.getElementById("snippetToShareList").append(elements[g]);
                            }
                        }
                        var bottom = document.createElement("p");
                        bottom.innerText = "------------------";
                        document.getElementById("snippetToShareList").append(bottom);
                    }
                
                    showAlert("got snippets", 3500, false)
                } else {
                    console.log("snippets is null")
                }


                // ---------------------------
            }

        // ----------------------------- (end of share code)

        function setMonacoEditorToDefault() {
            
            try {   
                deleteEditor(false);   
                // cannot read prop. of null error fix 
                // keeps editor div above <div class="context-view"> since without it, it causes errors since its targeting document.getElementById("monaco-editor").children[0] assuming its the editor div but it could the context view div causing errors so this just shuffles the divs to the right spot
                if(document.getElementById("monaco-editor") != null) {
                    for(e=0; e < document.getElementById("monaco-editor").children.length; e++) {
                        if(document.getElementById("monaco-editor").children[e].getAttribute("class") == "context-view") {
                            var otherdiv = document.getElementById("monaco-editor").children[e];
                            document.getElementById("monaco-editor").children[e].remove();
                            createEditor(true);
                            document.getElementById("monaco-editor").appendChild(otherdiv); 
                        } else {
                            createEditor(true);        
                        }
                    }
                }
                setTimeout(function() {savePreviousFile()}, 3000);
                console.log("Main: resetted editor")
            } catch(err){console.log(err)}

        }

        
        function deleteEditor(sta=true) { // sta = show the alert
            var editorList = monaco.editor.getEditors();
            for(a=0; a < editorList.length; a++) {
                monaco.editor.getEditors()[a].dispose();
            }
            if(editorList.length == 0) {
                if(!(sta)){return;}
                showAlert("no editor to delete", 5000, false);
            } else {
                if(!sta){return;}
                showAlert("deleted editor", 5000, false);
            }
            editor = null;
        }

        function createEditor(ol) { // ol = onload
            var templateCode = '<!DOCTYPE html>\n<html>\n\n<head>\n    <title>Example</title>\n</head>\n\n<body>\n    <h1>Hello, World!</h1>\n    <p>Write some code!</p>\n</body>\n\n</html>';
            if(getPreviousFileOnLoad) {
                templateCode = "";
            }
            if(ol) {
                // Monaco Editor (vs code in web)
                    require(['vs/editor/editor.main'], function () {
                        if(monaco.editor.getEditors().length == 1) {
                            deleteEditor(false); // this allows for a btn to reset the editor to the one that loads on load and if an editor exists already it deletes it.
                        }
                        editor = monaco.editor.create(document.getElementById('monaco-editor'), {
                            value: templateCode,
                            language: 'html',
                            theme: 'vs-dark',
                            automaticLayout: true,
                            minimap: {
                                enabled: false
                            }
                        });
                        
                        isUsingMonacoEditor = true;
                        
                    });
                // ------------------------------
            }
        }

        if(createEditorOnLoad) {    
            createEditor(true); // creates a monaco editor  createEditor(onload=true)
        } else {
            ignoreReturn = true;
        }
        
        function updateOutput(showAlertOnUpdate = true, save = true) {
            if (isUsingMonacoEditor) {
                try {
                    me = monaco.editor.getEditors()[0];
                    if(me == null) {return;}
                    const editor = me;
                    const code = me.getValue(); 
                    if (code.trim() !== "") {
                        const iframe = document.getElementById("output");

                        iframe.srcdoc = "";
                        iframe.srcdoc = code;

                        console.log("Main: updated output.");

                        if(snippetMovedToEditor != null) {

                            if(saveCodeOnUpdate && save) {
                                savePreviousFile(); // this saves the code in local storage variable previousFile
                            }

                            updateSnippetCode() // this saves the code in local storage variable ${snippetName} so for example you load a snippet and then start editing it when saving it will update the snippets code and will show updates in the snippets menu

                        } else {
                            if(saveCodeOnUpdate && save) { savePreviousFile(); }
                        }


                        if (showAlertOnUpdate) {
                            showAlert("updated output", 1000, false);
                        }

                        if(socket != null) {
                            var c = monaco.editor.getEditors()[0].getValue();
                            socket.send(JSON.stringify({ type: 'update', code: c }));
                        }
                    } else {
                        console.warn("Main: No code to update in iframe.");
                    }

                } catch (error) {
                    console.error("Main: Failed to update iframe output:", error);
                }
            }
        }

        let debounceTimer;
        if (editor) {
            editor.onDidChangeModelContent(() => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(updateOutput, 300); // Adjust delay as needed
            });
        }
        
        var fontSize = 14; // default
        
        function font(n, s=false) {

            if(s) {
                if(n>-1) {   
                    fontSize = n;
                }
            }

            if(String(n).includes("-")) {
                var before = String(document.getElementById("span").innerText);
                before = String(before).split(":")[1].replaceAll(" ", "");
                if(before == 1) {
                    document.getElementById("dec").style.color = "red";
                    setTimeout(function() {
                        document.getElementById("dec").style.color = "white";
                    }, 1700);
                    return;
                }
                //console.log("font is " + Number(before) + ", " + Number(before) + "-1 = " + (Number(before)-1) + "  setting font & span to: " + (Number(before)-1))
                fontSize = (Number(before)-1);
            } else if(!(String(n).includes("-"))){
                var before = String(document.getElementById("span").innerText);
                before = String(before).split(":")[1].replaceAll(" ", "");
                fontSize = (Number(before)+1);
            }

            monaco.editor.getEditors()[0].updateOptions({fontSize: fontSize})
            document.getElementById("span").innerText = ` Font: ${fontSize} `;
        };
        
        function switchToBaseEditor(delay=1000) {

            if(window.location.hostname == "kaleb1583.github.io") {
                window.location.href =  window.location.href + "/HTMLEditor.html";
            } else {
                window.location.href = String(window.location.href).replace("MonacoHTMLEditor.html", "HTMLEditor.html");
            }

        } // switch editor
    
        function showAlert(message="", ms=4000, removeOthers=false) {
            if(!(doAlert)) {
                return;
            }
            const container = document.getElementById("alert-container");
            container.style.zIndex = 1001; // (+1 more than the header zIndex)
            const alertElement = document.createElement("div");
            alertElement.className = "alert-message";
            alertElement.textContent = message;
            var removePreviousMessages = removeOthers;
            if(removePreviousMessages == true) {
                container.innerHTML = "";
            }
            container.appendChild(alertElement);
            setTimeout(() => {
                alertElement.remove();
            }, ms);

        }

        //  ----------------- SEPERATE JS FILES/SCRIPTS MOVED BACK INTO HTML  ----------------- 
        console.log("loaded options.")

        function resetOptions() {
            for (i=1; i <= optionCount; i++) {
                    const optionId = `option${i}`;
                    if(i==1||i==2||i==3||i==4||i==5) {  
                        // options that default to true   
                        localStorage.setItem(optionId, true);
                    } else if(false) {
                        // options that default to false (No options are false on default but i may create one in the future idk.)
                        //localStorage.setItem(optionId, false);
                    }
            }
            localStorage.setItem("fontSize", 14);
            checkForSavedOptions(true); // update
        }

        function saveOptions() {
            try {
                const options = {};

                for (j=1; j <= optionCount; j++) {
                    const optionId = `option${j}`;
                    const value = Boolean(document.getElementById(optionId).getAttribute('v'));
                    options[optionId] = value;
                    localStorage.setItem(optionId, value);
                }

                localStorage.setItem("fontSize", fontSize);

                const savedOptions = {
                    "alerts": options.option1,
                    "show fullscreen btn": options.option2,
                    "show export btn": options.option3,
                    "dark mode": options.option4,
                    "font size": fontSize,
                    "show line numbers": options.option5,
                    "auto save / load": options.option6,
                    "show snippets btn": options.option7,
                    "show share menu btn: ": options.option8,
                    // NEW-OPTION-CREATION

                };

                console.log("Options: saved options", savedOptions);
                showAlert("saved options", 4000, false);
            } catch (err) {
                showAlert("error saving options", 4000, false);
                console.log("error saving options: " + err)
            }
        }


        function checkForSavedOptions(isReset = false) {
            const savedOptions = {};

            for (k=1; k <= optionCount; k++) {
                savedOptions[`option${k}`] = localStorage.getItem(`option${k}`);
            }
            savedOptions.fontSize = localStorage.getItem("fontSize");

            if (savedOptions.option1 && savedOptions.option2 && savedOptions.option3 && savedOptions.option4 && savedOptions.option5 && savedOptions.option6 && savedOptions.option7 && savedOptions.option8 && savedOptions.fontSize) { // NEW-OPTION-CREATION
                const message = isReset ? "reset options." : "options loaded";
                showAlert(message, 3000, false);
            }

            console.log("Options: loading saved options.", savedOptions);

            for (let l = 1; l <= optionCount; l++) {
                const optionValue = savedOptions[`option${l}`];
                if (optionValue !== null) {
                    toggleOption(l, optionValue === "true");
                }
            }

            if (savedOptions.fontSize !== null) {
                monaco.editor.getEditors()[0].updateOptions({ fontSize: savedOptions.fontSize });
                fontSize = savedOptions.fontSize;
                document.getElementById("span").innerText = ` Font: ${fontSize} `;
            }
        }



        function toggleOptionMenu() {
            options = document.getElementById("options-container");
            if(isSnippetsOpen) {showAlert("Close snippets first.", 3000, false);return;}
            if(isShareMenuOpen) {showAlert("Close share menu first.", 3000, false);return;}
            if(isCollabMenuOpen) {showAlert("Close collab menu first.", 3000, false);return;}
            if(options.style.display == "block") {
                // hide options
                isOptionsOpen = false;
                options.style.display = "none";
                output.hidden = false;
                setTimeout(function() {updateOutput(false)}, 750);
                saveOptions();
                optionsBtn.innerText = "Options";
            } else {
                // show options
                isOptionsOpen = true;
                options.style.display = "block";
                output.hidden = true;
                //showAlert("showing options", 1500, true)
                optionsBtn.innerText = "Close Options";
            }
        };

        function toggleOption(option, v=null) { 
            // for loading previous options, toggleOption(1, true) sets option1 to true   if no value is given it just toggles it

            if(document.getElementById(`option${option}`) == null) {return;} // if option element not found dont try anything

            if(v == null) { // toggle
                // green if enabled / red if disabled
                if(document.getElementById(`option${option}`).style.color == "green") {
                    document.getElementById(`option${option}`).style.color = "red";   
                    document.getElementById(`option${option}`).setAttribute("v", "");
                } else if(document.getElementById(`option${option}`).style.color == "red"){
                    document.getElementById(`option${option}`).style.color = "green";
                    document.getElementById(`option${option}`).setAttribute("v", "true");
                }
            } else if(!(v == null)) { // set option to v(alue)
                if(v == true) {
                    document.getElementById(`option${option}`).style.color = "green";
                    document.getElementById(`option${option}`).setAttribute("v", "true");
                } else if(v == false) {
                    document.getElementById(`option${option}`).style.color = "red";   
                    document.getElementById(`option${option}`).setAttribute("v", "");
                }
            }

            // code for the options

            if(document.getElementById("option1").getAttribute("v") == "true") {
                doAlert = true;
            } else if(document.getElementById("option1").getAttribute("v") == ""){ 
                doAlert = false;
            }

            if(document.getElementById("option2").getAttribute("v") == "true") {
                fullscreenBtn.hidden = false;
            } else if(document.getElementById("option2").getAttribute("v") == ""){
                fullscreenBtn.hidden = true;
            }   

            if(document.getElementById("option3").getAttribute("v") == "true") {
                exportBtn.hidden = false;
            } else if(document.getElementById("option3").getAttribute("v") == ""){
                exportBtn.hidden = true;
            }

            if(document.getElementById("option4").getAttribute("v") == "true") {
                monaco.editor.setTheme("vs-dark");
            } else if(document.getElementById("option4").getAttribute("v") == ""){
                monaco.editor.setTheme("vs");
            }
            
            if(document.getElementById("option5").getAttribute("v") == "true") {
                monaco.editor.getEditors()[0].updateOptions({lineNumbers: true})
            } else if(document.getElementById("option5").getAttribute("v") == "") {
                monaco.editor.getEditors()[0].updateOptions({lineNumbers: false})
            }

            if(document.getElementById("option6").getAttribute("v") == "true") {
                getPreviousFileOnLoad = true;
                saveCodeOnUpdate = true;
            } else if(document.getElementById("option6").getAttribute("v") == "") {
                getPreviousFileOnLoad = false;
                saveCodeOnUpdate = false;
            }

            if(document.getElementById("option7").getAttribute("v") == "true") {
                document.getElementById("snippetsBtn").hidden = false;
            } else if(document.getElementById("option7").getAttribute("v") == "") {
                document.getElementById("snippetsBtn").hidden = true;
            }

            if(document.getElementById("option8").getAttribute("v") == "true") {
                document.getElementById("shareBtn").hidden = false;
            } else if(document.getElementById("option8").getAttribute("v") == "") {
                document.getElementById("shareBtn").hidden = true;
            }

            // NEW-OPTION-CREATION
            // this is the code for options, it handles what to do for each option by checking if its true or false and then it toggles the option for example showing or hiding a button
        }

        // - Above: Options - Below: CodeSaverLoader -
        
        console.log("loaded CodeSaveLoader.")

        function savePreviousFile() {
            try {
                var me = null;
                for(u=0; u < monaco.editor.getEditors().length; u++) {
                    if(monaco.editor.getEditors()[u]._domElement == document.getElementById("monaco-editor")) {
                        me = monaco.editor.getEditors()[u];
                    }
                }

                if(me != null) {
                    var lastInputFileValue = me.getValue();
                    //  lastInputFileValue = lastInputFileValue.replace(/\u00A0/g, ' ');
                    localStorage.setItem("lastFile", lastInputFileValue);
                    console.log("Saver/Loader: saved code.");
                } 

            } catch(err) {
                
                console.log("Saver/Loader: error saving code", err);

            }
        }

        function getPreviousFile() {
            try {
                var pF = localStorage.getItem("lastFile");

                if (pF != null && pF != "") {

                    if(detectIfPreviousFileIsASnippetAndLoadSnippet) {
                        // ---- this is for detecting if the user's last code was a snippet and if so it will load the snippet so when saving it will update the snippet
                        // (more shortly: if the code last saved is a snippet get the snippet so when the user saves it will update the snippet code)
                        var snippetArr = localStorage.getItem("snippets").split(",");
                        for(i=0; i < snippetArr.length; i++) {
                            var selectedSnippetName = String(snippetArr[i]);
                            if(selectedSnippetName == "Example") {continue;}
                            if(pF = localStorage.getItem(selectedSnippetName)) {
                                setTimeout(function() {
                                    monaco.editor.getEditors()[0]._domElement.style.display = "none";
                                    doAlert = false;
                                    console.log("Saver/Loader: previous code is a snippet with name: " + selectedSnippetName);  
                                    openSnippets();
                                    getASnippet(selectedSnippetName);
                                    doAlert = true;
                                    editSnippet(selectedSnippetName, true);
                                    monaco.editor.getEditors()[0]._domElement.style.display = "block";
                                }, 3000);
                                break;
                            }
                        }
                    }

                    setTimeout(function() {
                        if (editor != null) {
                            pF = pF.replace(/\u00A0/g, ' ');
                            editor.setValue(pF);
                            showAlert("code loaded", 2000, false);
                            console.log("Saver/Loader: got saved code.");
                        } 
                    }, 2000);
                }
            } catch(err) {
                console.log("Saver/Loader: error loading previous code", err)
            }
        }

        // - Above: CodeSaverLoader - Below: Export -

        console.log("loaded export.")

        const save = (data, filename) => {
            const blob = new Blob([data], { type: "text/html" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            a.click();
        };

        function mkExport() {
            showAlert("attempting to export", 1000, false)
            console.log("Export: attempting to export")
            try {
                var exportCode = document.getElementById("monaco-editor").firstChild.firstChild.children[1].innerText;
                if(exportCode != "" || String(exportCode) != templateCode) {
                    console.log("Export: showing save file in os file manager")
                    save(exportCode, "output.html");
                } else {
                    console.log("Export: theres no code to export.")
                    showAlert("write some code before trying to export!", 3, false);
                }
            } catch(err) {
                if(document.getElementById("monaco-editor").firstChild == null) {      
                    setTimeout(function() {showAlert("no editor & no code to export.", 2000, false)}, 1100)
                } else {     
                    setTimeout(function() {showAlert("Error: cant export code", 2000, false)}, 1100)
                }
                console.log("err making export", err)
            }
        }
        // - Above: Export - Below: EventListeners -

        try {
            setTimeout( function() {

                console.log("loaded event listeners.")

                // --- event listeners ---

                document.addEventListener("keydown", function (event) { // ctrl
                    try{
                        if(!(isUsingMonacoEditor)) {return;} 
                        if ((event.ctrlKey || event.metaKey) && event.key === "s") {
                            event.preventDefault();
                            if(isUsingMonacoEditor) {
                                updateOutput();
                            }
                        }
                    } catch(err) {
                        //console.log(err)
                    }
                });

                document.addEventListener("keydown", function (event) {
                    try {
                        if(!(isUsingMonacoEditor)) {return;} 
                        if (event.key == "Escape") {
                            if(isSnippetsOpen) {
                                openSnippets();
                                return;
                            } 
                            if(isShareMenuOpen) {
                                openShareMenu();
                                return;
                            }
                            event.preventDefault();
                            toggleOptionMenu();
                        }
                    } catch(err) {
                        //console.log(err)
                    }
                });


                try {
                    const fullscreenBtn = document.getElementById('fullscreenBtn');
                    fullscreenBtn.addEventListener('click', () => {
                        const isFullscreen = inputContainer.style.display === 'none';
                        if (isFullscreen) {
                            inputContainer.style.display = 'flex';
                            fullscreenBtn.textContent = 'Full Screen';
                            outputContainer.style.flex = '1';
                        } else {
                            inputContainer.style.display = 'none';
                            fullscreenBtn.textContent = 'Exit Full Screen';
                            outputContainer.style.flex = 'none';
                            outputContainer.style.width = '100%';
                        }
                    });
                } catch(err) {
                    //console.log(err)
                }
                // -----------------------

            }, 2000); // setTimeout

        } catch(err) { // main event listeners try catch
            console.log("EventListeners: err", err)
        }

        //  -----------------------------------------------------------------


        // --- collab stuff code stuff things functions code things yeah collab stuff functions code things ---

        function openCollabMenu() {
            if(isOptionsOpen) {showAlert("Close options first.", 3000, false);return;}
            if(isSnippetsOpen) {showAlert("Close snippets first.", 3000, false);return;}

            var collabMenu = document.getElementById("collabMenu");

            if(collabMenu.style.display == "block") {
                isCollabMenuOpen = false;
                console.log("hiding collab menu")
                collabMenu.style.display = "none";
                document.getElementById("collabButtons").style.display = "none";
                document.getElementById("output-container").hidden = false;
                document.getElementById("collabBtn").innerText = "Collab";
            } else {
                isCollabMenuOpen = true;
                console.log("showing collab menu")
                collabMenu.style.display = "block";
                document.getElementById("collabButtons").style.display = "block";
                document.getElementById("output-container").hidden = true;
                document.getElementById("collabBtn").innerText = "Close Collab Menu";
            }
        }

        function closeWebSocket() {
            try {
                if(socket) {
                    var conf = confirm("close session?");
                    if(!(conf)) {return;}
                    
                    socket.close();
                    document.getElementById("id").innerText = "None."; 
                    document.getElementById("collabMessage").style.display = "block";

                    var conf2 = confirm("save code?");
                    if(conf2) {
                        var snna = prompt("save code as snippet:");
                        if(snna != null && snna != "") {
                            createSnippet(monaco.editor.getEditors()[0].getValue(), snna);
                        }
                    }
                }
            } catch(err) {err;}
        }

        // Function to connect to the WebSocket server
        function connect() {
            try {
                socket = new WebSocket('wss://imported-brainy-cream.glitch.me');

                socket.addEventListener('open', () => {
                    console.log('Connected to WebSocket server');
                    document.getElementById('status').innerText = 'Connected';
                    document.getElementById('status').style.color = 'green';
                });

                socket.addEventListener('message', (event) => {
                    const data = JSON.parse(event.data);

                    if (data.type === 'created') {
                        currentSessionId = data.sessionId;
                        console.log(`Session created with ID: ${currentSessionId}`);
                        document.getElementById('id').innerText = `${currentSessionId}`;
                        updateIn = true;
                    }

                    if (data.type === 'joined') {
                        //currentSessionId = data.sessionId; // Update the sessionId
                        console.log('Joined session successfully!');
                        document.getElementById('id').innerText = `${document.getElementById("joinSessionId").innerText}`;
                        monaco.editor.getEditors()[0].setValue(data.code);
                        updateOutput(false, false);
                    }

                    if (data.type === 'update') {
                        const editor = monaco.editor.getEditors()[0];
                        const currentCode = editor.getValue();
                        if (currentCode !== data.code) {
                            editor.setValue(data.code);
                            updateOutput(false, false);
                        }
                    }

                    if (data.type === 'notification') {
                        showAlert(data.message, 4000, false);
                    }

                    if (data.type === 'error') {
                        console.error(`Error: ${data.message}`);
                    }
                    
                });

                socket.addEventListener('error', (error) => {
                    console.error('WebSocket error:', error);
                    document.getElementById('status').innerText = 'Error';
                    document.getElementById('status').style.color = 'red';
                    setTimeout(() => {
                        document.getElementById('status').innerText = 'Disconnected';
                    }, 5000);
                });

                socket.addEventListener('close', () => {
                    console.log('WebSocket connection closed');
                    document.getElementById('status').innerText = 'Server Offline!';
                    document.getElementById('status').style.color = 'red';
                    setTimeout(() => {
                        document.getElementById('status').innerText = 'Disconnected';
                    }, 5000);
                });

            } catch (err) {
                console.log("connect() error:", err);
            }
        }

        function createSession() {
            if (socket !== null) {
                socket.send(JSON.stringify({ type: 'create' }));
            }
        }

        function joinSession() {
            if (socket !== null) {
                const sessionId = prompt('Enter the session ID');
                if (sessionId !== null && sessionId !== '') {
                    var span = document.createElement("span");
                    span.style.display = "none";
                    span.id = "joinSessionId";
                    span.innerText = sessionId;
                    document.body.append(span);
                    socket.send(JSON.stringify({ type: 'join', sessionId: sessionId }));
                }
            }
        }

        document.getElementById('createSessionBtn').addEventListener('click', () => {
            if(document.getElementById('createSessionBtn').disabled) {
            document.getElementById('createSessionBtn').style.color = "red";
            setTimeout(function() {document.getElementById('createSessionBtn').style.color = "white";}, 2000)
            }
            createSession();
        });

        document.getElementById('joinSessionBtn').addEventListener('click', () => {
            joinSession();
        });

        document.getElementById('connectBtn').addEventListener('click', () => {
            connect();
        });

        /*
        socket.onclose = function() {
            closeWebSocket();
        }
        window.onbeforeunload = function() {
            closeWebSocket();
        };
        */

        function handleButtons() { // shows or hides buttons based on if theres a session or if you're connected to the server
            var isThereASession = document.getElementById("id").innerText != "None.";
            if(isThereASession) {
                document.getElementById("createSessionBtn").style.display = "none";
                document.getElementById("joinSessionBtn").style.display = "none";
                document.getElementById("closeWebSocketBtn").style.display = "block";
                document.getElementById("collabMessage").style.display = "block";
            } else {
                var sit = document.getElementById("status").innerText;
                if(sit == "Disconnected" || sit == "Server Offline!" || sit == "Error") {     
                    document.getElementById("connectBtn").style.display = "block";
                    document.getElementById("createSessionBtn").style.display = "none";
                    document.getElementById("joinSessionBtn").style.display = "none";
                    document.getElementById("closeWebSocketBtn").style.display = "none";
                } else {
                    document.getElementById("connectBtn").style.display = "none";
                    document.getElementById("createSessionBtn").style.display = "block";
                    document.getElementById("joinSessionBtn").style.display = "block";
                    document.getElementById("closeWebSocketBtn").style.display = "none";
                }
            }
        }

        function autoUpdate() {
            if(socket != null) {
                var c = monaco.editor.getEditors()[0].getValue();
                socket.send(JSON.stringify({ type: 'update', code: c }));
            }
        }

        setInterval(function() {
            handleButtons();
        }, 100);

        setInterval(function() {
            if(document.getElementById("id") != null) {
                if(document.getElementById("id").innerText != "None.") {    
                    autoUpdate();
                }
            }
        }, 500)
        // ----------------------------------------------------------------------------------------------------


        function loadSnippetFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const snippet = urlParams.get('snippet');
            if (snippet) {
                getPreviousFileOnLoad = false;
                const decodedSnippet = decodeURIComponent(snippet); 
                monaco.editor.getEditors()[0].setValue(decodedSnippet);
                setTimeout(function() {showAlert("loaded shared code snippet", 3000, false);}, 2000);
            }
        }            

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Insert') {
                var input = prompt("code to eval?");
                if(input && input != "") {
                    try {
                        eval(input);
                    } catch(err) {
                        showAlert("error running code, check console.", 3000, false)
                        console.log(err)
                    }
                }
            }
        });


        setTimeout(function() {
            try {
                if(monaco && monaco.editor != null) {
                    checkForSavedOptions();
                }  
            } catch(err) {
                //console.log(err)
            }
        }, 1000);

        setTimeout(function() {
            updateOutput(false, false)
        }, 3000);

        
        setTimeout(function() {
            try {
                if(monaco && monaco.editor != null) {
                    loadSnippetFromURL();
                }  
            } catch(err) {
                console.log(err)
            }
        }, 1000);

        if(getPreviousFileOnLoad) {
            try {
                console.log("get previous file on load")
                getPreviousFile();
                setTimeout(function() {
                
                    if(editor != null) {
                        editor.getAction('editor.action.formatDocument').run();   
                    }

                }, 2000)
            } catch(err) {
                //console.log(err)
            }
        }
        
    </script>

</body>

</html>
