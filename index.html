<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monaco HTML Editor</title>

    <!-- css stylesheets -->
    <link rel="stylesheet" href="./assets/css/styles.css"> <!-- main css for editor -->
    <!-- end of css -->

    <script> // before loading / importing
        var scriptsLoaded = []; // scripts below use this variable so its needs to be defined before the scripts run.
    </script>

    <!-- scripts -->

        <!-- parts of the main js code broken up -->
            
            
            <script id="ScriptElement" src="./assets/monaco-editor/0.52.2/min/vs/loader.js"></script>   
            <script id="" src="./assets/js/Options.js"></script> 
            <script id="" src="./assets/js/EventListeners.js"></script>
            <script id="" src="./assets/js/Export.js"></script>
            <script id="" src="./assets/js/CodeSaverLoader.js"></script>
            <!---->

        <!-- end -->

    <script> // after loading / importing

        
        console.log("--- done loading scripts, main script starting ---")

        // functions to help check if all the scripts were loaded.
        
        function compareArray(arr1, arr2) {
            if (arr1 == null || arr2 == null) {return null;}
            if (arr1.length !== arr2.length) {return false;}
            const normalize = (arr) => arr.map((val) => val.toString().trim().toLowerCase()).sort();
            const normalizedArr1 = normalize(arr1);
            const normalizedArr2 = normalize(arr2);
            return normalizedArr1.every((val, index) => val === normalizedArr2[index]);
        }

        function findMissing(expected, loaded) {
            const normalize = (arr) => arr.map((val) => val.toString().trim().toLowerCase());
            const normalizedExpected = normalize(expected);
            const normalizedLoaded = normalize(loaded);
            const missing = normalizedExpected.filter((script) => !normalizedLoaded.includes(script));
            return missing.map((script) => expected.find((originalScript) => originalScript.toLowerCase().trim() === script));
        }

    </script>

    <!-- end of scripts -->

</head>
<body>


    <div id="alert-container"></div>

    <div id="editor-container" class="editor-container">

        <header id="header" class="top-bar">
            <div id="buttons">
                <button style="color: white" id="fullscreenBtn">Full Screen</button>
                <button style="color: white" id="exportBtn" onclick="mkExport()">Export</button>
                <button style="color: white" id="optionsBtn" class="optionsBtn" onclick="toggleOptionMenu()">Options</button>
            </div>
        </header>

        <div id="input-container" style="width: 50%;">
            <div id="monaco-editor"></div>
        </div>

        <div id="divider" style="width: 3px; background-color: #ccc; flex-shrink: 0;"></div>

        <div id="output-container" style="width: 50%;">

            <iframe id="output"></iframe>

            <div id="options-container" style="width: 50%; height: 100%; margin-top: 48px; display: none;">

                <div id="options">
                    <h4><b>Options</b></h4>
                    <p id="option1" onclick="toggleOption(1)" v="true" style="color: green">Alerts/Popups</p>
                    <p id="option2" onclick="toggleOption(2)" v="true" style="color: green">Show Fullscreen Button</p>
                    <p id="option3" onclick="toggleOption(3)" v="true" style="color: green">Show Export Button</p>
                    <p id="option4" onclick="toggleOption(4)" v="true" style="color: green">Dark Mode</p>   
                    <p id="option5" onclick="toggleOption(5)" v="true" style="color: green">Show Line Numbers</p>
                    <p id="option6" onclick="toggleOption(6)" v="true" style="color: green">Save & Auto Load Code</p>
                    <button style="color: white" onclick="font(-1)" id="dec">-</button><span id="span"> Font: 14 </span><button id="inc" style="color: white" onclick="font(1)">+</button>
                    <br><br>
                    <button style="color: white" id="resetMonacoEditorValue" onclick="setMonacoEditorToDefault()">Reset Editor</button>
                    <br><br>
                    <button style="color: white" onclick="switchToBaseEditor()">Switch To Basic Editor</button>
                    <br><br>
                    <button style="color: white" onclick="resetOptions()">Reset Options</button>
                </div>

            </div>

        </div>
    </div>

    <script>
        
        // so this editor is a little weird when it comes to getting monaco so i made it so theres checks when initializing

        let editor; // this is what holds the monaco editor 
        const output = document.getElementById('output'); // iframe output
        const inputContainer = document.getElementById('input-container'); // input container with monaco-editor (50% left side)
        const outputContainer = document.getElementById('output-container'); // output container with output (50% right side)
        const optionCount = 6; // so for loops know how many times to loop (switched to loops instead of a bunch of if or switch case statements to keep this shorter in lines).
        var doAlert = true; // do allow alerts, true by default  set to show alerts option value on load (toggleOption()).
        var isUsingMonacoEditor = false;   // prevents errors that can happen after switching to the basic editor caused by event listeners either attempting to interact with a deleted element or trying to update the output of the then deleted monaco editor.
        var isOriginalEditor = true; // if the original editor is deleted this is set to false.
        var isThereAnEditor = Boolean(document.getElementById("monaco-editor").firstChild == null); // if theres a element in monaco-editor / if theres an editor
        var getPreviousFileOnLoad = true; // gets previous file on load if this is true, if set to false in options this becomes false.
        var saveCodeOnUpdate = true; // if this is true then it saves code on update, if set to false in options this becomes false       save code automatically and load file on page load are one option(6).
        var createEditorOnLoad = true; // true by default, if false: its loads like normal
        var ignoreReturn = false; // ignore isusingmonacoeditor false -> return for the no editor alert so if createEditorOnLoad is false it shows the no editor alert
        var scripts = ["Monaco-Editor", "Options", "Export", "CodeSaverLoader"]; // exclude eventlisteners since its delayed.
        var scriptsToLoadCount = 4;
        var canUseRequire = null;  

        // note i use options and settings interchangeably, whoops.
        
        const url = new URL(window.location.href);
        const params = new URLSearchParams(url.search);

        try {
            require.config({
                paths: {
                    'vs': './assets/monaco-editor/0.52.2/min/vs/'
                }
            });
        } catch(err) {
            canUseRequire = false;
            console.log("require err, most likely monaco-ediitor couldnt be loaded")//, err)
            showAlert("Error with monaco editor, try refreshing!", 5000, false);

        }

        function scriptLoader() {
            console.log("Main: script loader runned")
            var aresame = compareArray(scripts, scriptsLoaded);
            if(aresame) {
                doRun=true;
                console.log("Main: all scripts loaded successfully.")
            } else if(!(aresame)) {
                doRun = false;
                createEditorOnLoad = false;
                if(scripts.length != scriptsLoaded.length) {
                    console.log("Main: missing scripts!")
                    document.getElementById("editor-container").style.display = "none";

                    missing = findMissing(scripts, scriptsLoaded);

                    var scriptContainer = document.createElement("div");
                    scriptContainer.id = "ScriptLoaderContainer";
                    scriptContainer.style.display = "block";

                    var header = document.createElement("h4");
                    header.innerHTML = "<b>Problems loading editor.</b>";
                    scriptContainer.appendChild(header);

                    if (missing.includes("Monaco-Editor")) {
                        console.log("Main: missing file: Monaco Editor!");
                        var meE = document.createElement("p");
                        meE.id = "meE";
                        meE.style.color = "red";
                        meE.innerHTML = "Couldnt Load: Monaco Editor";
                        scriptContainer.appendChild(meE);
                    }

                    if (missing.includes("Options")) {
                        console.log("Main: missing file: Options!");
                        var oE = document.createElement("p");
                        oE.id = "oE";
                        oE.style.color = "#CC9900";
                        oE.innerHTML = "Couldnt Load: Options";
                        scriptContainer.appendChild(oE);
                    }

                    if (missing.includes("CodeSaverLoader")) {
                        console.log("Main: missing file: CodeSaverLoader!");
                        var cslE = document.createElement("p");
                        cslE.id = "cslE";
                        cslE.style.color = "#CC9900";
                        cslE.innerHTML = "Couldnt Load: Code Saver & Loader";
                        scriptContainer.appendChild(cslE);
                    }

                    if (missing.includes("Export")) {
                        console.log("Main: missing file: Export!");
                        var eE = document.createElement("p");
                        eE.id = "eE";
                        eE.style.color = "#CC9900";
                        eE.innerHTML = "Couldnt Load: Export";
                        scriptContainer.appendChild(eE);
                    }

                    console.log("Main: " + scriptsLoaded.length + "/" + scripts.length + " scripts loaded.")

                    var footer = document.createElement("div");
                    footer.id = "footer";

                    if (missing.includes("Monaco-Editor")) {
                        footer.innerHTML = "<br> <b>try refreshing: </b> <button onclick='window.location.reload()'>Refresh</button> <br> <b>Or use basic editor: </b><button onclick='switchToBaseEditor()'>Switch To Basic Editor</button>";
                    } else {
                        var fv = ""; // Initialize the missing components string
                        var missingComponents = []; 

                        if (missing.includes("Options")) {
                            missingComponents.push("Options");
                        }
                        if (missing.includes("CodeSaverLoader")) {
                            missingComponents.push("CodeSaverLoader");
                        }
                        if (missing.includes("Export")) {
                            missingComponents.push("Export");
                        }

                        if (missingComponents.length > 0) {
                            fv = "Continue without: " + missingComponents.join(" & ");
                        }

                        footer.innerHTML = "</button> <br> <button id='retryScriptsLoadBtn' onclick='retryScriptsLoad()'>Try to load scripts again</button>" + "<br><button id='continueWithoutMissingOptionsBtn' onclick='continueWithoutMissingOptions()'>" + String(fv);
                    }


                    scriptContainer.appendChild(footer);
                    document.body.appendChild(scriptContainer);

                }
            } else {
                doRun = true;
            }

        }

        scriptLoader();

        function missingScriptsInfo() {if(scripts!=null&&scriptsLoaded!=null){console.log("Scripts", scripts);console.log("Scripts Loaded", scriptsLoaded);console.log(scriptsLoaded.length + "/" + scripts.length + " scripts loaded")}}

        function continueWithoutMissingOptions() {
            // user can continue without options, code saver / loader, and export since they can be optional (but if monaco-editor is missing then the user has to use the basic editor which doesnt have options,code saver loader, & export which in that case this isnt needed)
            console.log("continuing with missing (optional) scripts ") 
            if(document.getElementById("ScriptLoaderContainer") != null && document.getElementById("editor-container") != null) {

                if(missing != null) {
                    document.getElementById("continueWithoutMissingOptionsBtn").style.display = "none";
                    document.getElementById("retryScriptsLoadBtn").style.display = "none";
                    document.getElementById("footer").innerHTML = "<br> <b>loading editor...</b>";

                    if(missing.includes("Options")) {
                        if(document.getElementById("optionsBtn") != null) {
                            document.getElementById("optionsBtn").style.display = "none";
                        } 
                    }   

                    if(missing.includes("CodeSaverLoader")) {
                        getPreviousFileOnLoad = false;
                        saveCodeOnUpdate = false;
                    }   

                    if(missing.includes("Export")) {
                        if(document.getElementById("exportBtn") != null) {
                            document.getElementById("exportBtn").style.display = "none";
                        }
                    }

                    setTimeout(function() {
                        document.getElementById("ScriptLoaderContainer").remove();
                        document.getElementById("editor-container").style.display = "block";
                        createEditor(true);
                    }, 2000);

                }
            }
                            
        }

        function retryScriptsLoad() {

            console.log("Main: attemping to load scripts again.")

            if(missing != null) {

                if(missing.includes("Options")) {
                    var script = document.createElement('script');
                    script.src = "./assets/js/Options.js";
                    document.body.appendChild(script);
                }

                if(missing.includes("CodeSaverLoader")) {
                    var script = document.createElement('script');
                    script.src = "./assets/js/CodeSaverLoader.js";
                    document.body.appendChild(script);
                } 
                
                if(missing.includes("Export")) {
                    var script = document.createElement('script');
                    script.src = "./assets/js/Export.js";
                    document.body.appendChild(script);
                } 

                document.getElementById("footer").innerHTML = "<br> Updating...";
                setTimeout(function() {     
                    scriptLoader();
                    setTimeout(function() {
                        if(doRun == true) {           
                            showAlert("scripts are now all loaded!", 4000, false)
                            document.getElementById("editor-container").style.display = "block";
                            createEditor(true);
                            document.getElementById("ScriptLoaderContainer").remove();
                        }
                    }, 2000);
                }, 2000);

            } else {
                console.log("missing is null")
            }

        }

        function setMonacoEditorToDefault() {
            
            try {   
                deleteEditor(false);   
                // cannot read prop. of null error fix 
                // keeps editor div above <div class="context-view"> since without it, it causes errors since its targeting document.getElementById("monaco-editor").children[0] assuming its the editor div but it could the context view div causing errors so this just shuffles the divs to the right spot
                if(document.getElementById("monaco-editor") != null) {
                    for(v=0; v < document.getElementById("monaco-editor").children.length; v++) {
                        if(document.getElementById("monaco-editor").children[v].getAttribute("class") == "context-view") {
                            var otherdiv = document.getElementById("monaco-editor").children[v];
                            document.getElementById("monaco-editor").children[v].remove();
                            createEditor(true);
                            document.getElementById("monaco-editor").appendChild(otherdiv); 
                        } else {
                            createEditor(true);        
                        }
                    }
                }
                setTimeout(function() {savePreviousFile()}, 3000);
                console.log("Main: resetted editor")
            } catch(err){console.log(err)}

        }

        
        function deleteEditor(sta=true) { // sta = show the alert
            var editorList = monaco.editor.getEditors();
            for(o=0; o < editorList.length; o++) {
                monaco.editor.getEditors()[o].dispose();
            }
            if(editorList.length == 0) {
                if(!(sta)){return;}
                showAlert("no editor to delete", 5000, false);
            } else {
                if(!sta){return;}
                showAlert("deleted editor", 5000, false);
            }
            editor = null;
        }

        function createEditor(ol) { // ol = onload
            var templateCode = '<!DOCTYPE html>\n<html>\n\n<head>\n    <title>Example</title>\n</head>\n\n<body>\n    <h1>Hello, World!</h1>\n    <p>Write some code!</p>\n</body>\n\n</html>';
            if(ol) {
                // Monaco Editor (vs code in web)
                    require(['vs/editor/editor.main'], function () {
                        if(monaco.editor.getEditors().length == 1) {
                            deleteEditor(false); // this allows for a btn to reset the editor to the one that loads on load and if an editor exists already it deletes it.
                        }
                        editor = monaco.editor.create(document.getElementById('monaco-editor'), {
                            value: templateCode,
                            language: 'html',
                            theme: 'vs-dark',
                            automaticLayout: true,
                            minimap: {
                                enabled: false
                            }
                        });
                        
                        isUsingMonacoEditor = true;
                        
                    });
                // ------------------------------
            }
        }

        if(createEditorOnLoad) {    
            createEditor(true); // creates a monaco editor  createEditor(onload=true)
        } else {
            ignoreReturn = true;
        }
        
        function updateOutput(showAlertOnUpdate = true, save = true) {
            if (isUsingMonacoEditor) {
                try {
                    const editor = monaco.editor.getModels()[0];
                    const code = editor.getValue(); 

                    if (code.trim() !== "") {
                        const iframe = document.getElementById("output");

                        iframe.srcdoc = "";
                        iframe.srcdoc = code;

                        console.log("Main: updated output.");

                        if(saveCodeOnUpdate && save) { savePreviousFile(); }

                        if (showAlertOnUpdate) {
                            showAlert("updated output", 1000, false);
                        }
                    } else {
                        console.warn("Main: No code to update in iframe.");
                    }
                } catch (error) {
                    console.error("Main: Failed to update iframe output:", error);
                }
            }
        }

        let debounceTimer;
        if (editor) {
            editor.onDidChangeModelContent(() => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(updateOutput, 300); // Adjust delay as needed
            });
        }
        
        var fontSize = 14; // default
        
        function font(n, s=false) {

            if(s) {
                if(n>-1) {   
                    fontSize = n;
                }
            }

            if(String(n).includes("-")) {
                var before = String(document.getElementById("span").innerText);
                before = String(before).split(":")[1].replaceAll(" ", "");
                if(before == 1) {
                    document.getElementById("dec").style.color = "red";
                    setTimeout(function() {
                        document.getElementById("dec").style.color = "white";
                    }, 1700);
                    return;
                }
                //console.log("font is " + Number(before) + ", " + Number(before) + "-1 = " + (Number(before)-1) + "  setting font & span to: " + (Number(before)-1))
                fontSize = (Number(before)-1);
            } else if(!(String(n).includes("-"))){
                var before = String(document.getElementById("span").innerText);
                before = String(before).split(":")[1].replaceAll(" ", "");
                fontSize = (Number(before)+1);
            }

            monaco.editor.getEditors()[0].updateOptions({fontSize: fontSize})
            document.getElementById("span").innerText = ` Font: ${fontSize} `;
        };
        
        function switchToBaseEditor(delay=1000) {

            if(document.getElementById("ScriptLoaderContainer") != null && document.getElementById("ScriptLoaderContainer") == "")

            isUsingMonacoEditor = false;
            isOriginalEditor = false;
            setTimeout(function() {
                
                const result = window.confirm("do you want to switch to the basic editor?");
    
                if (result) {
                    const container = document.getElementById("alert-container");
                    container.style.zIndex = 11; // (+1 more than the header zIndex)
                    const alertElement = document.createElement("div");
                    alertElement.className = "alert-message";
                    alertElement.textContent = "switching to basic editor";
                    container.appendChild(alertElement);

                    if(document.getElementById("editor-container") != null) {document.getElementById("editor-container").remove();}

                    var baseEditorContainer = document.createElement("iframe");
                    baseEditorContainer.id = "baseEditor";
                    baseEditorContainer.srcdoc = "";
                    //document.getElementById("alertInPage").style.display = "none";
                    document.body.append(baseEditorContainer);
                    document.title = "html editor";
                    //document.getElementById("alertInPage").remove();
                    document.getElementById("alert-container").remove();
                    if(document.getElementsByClassName("monaco-aria-container")[0] != null) {
                        document.getElementsByClassName("monaco-aria-container")[0].remove();
                    }
                } else {
                    // canceled switch
                }
            }, delay);

        } // switch editor
    
        function showAlert(message="", ms=4000, removeOthers=false) {
            if(!(doAlert)) {
                return;
            }
            const container = document.getElementById("alert-container");
            container.style.zIndex = 1001; // (+1 more than the header zIndex)
            const alertElement = document.createElement("div");
            alertElement.className = "alert-message";
            alertElement.textContent = message;
            var removePreviousMessages = removeOthers;
            if(removePreviousMessages == true) {
                container.innerHTML = "";
            }
            container.appendChild(alertElement);
            setTimeout(() => {
                alertElement.remove();
            }, ms);

        }

        setTimeout(function() {
            try {
                if(monaco && monaco.editor != null) {
                    checkForSavedOptions();
                }  
            } catch(err) {
                //console.log(err)
            }
        }, 1000);

        setTimeout(function() {
            updateOutput(false, false)
        }, 1500);
        
        if(getPreviousFileOnLoad) {
            try {
                getPreviousFile();
                setTimeout(function() {
                
                    if(editor != null) {
                        editor.getAction('editor.action.formatDocument').run();   
                    }

                }, 2000)
            } catch(err) {
                //console.log(err)
            }
        }


        
    </script>
</body>

</html>
